<!doctype html>
<html class="no-js">
<title>资源列表</title>

<link rel="stylesheet" type="text/css" href="/ui/css/global/animate.css" />
<link rel="stylesheet" type="text/css" href="/ui/css/global/bootstrap.min.css" />
<link rel="stylesheet" type="text/css" href="/ui/css/global/font-awesome.min.css" />
<link rel="stylesheet" type="text/css" href="/ui/css/global/simple-line-icons.css" />
<link rel="stylesheet" type="text/css" href="/ui/css/global/style.css" />
<link rel="stylesheet" type="text/css" href="/ui/css/main.css" />
<link rel="stylesheet" type="text/css" href="/ui/css/plugins/grid/bsgrid.all.min.css" />
<link rel="stylesheet" type="text/css" href="/ui/css/plugins/iCheck/icheck.css" />
<link rel="stylesheet" type="text/css" href="/ui/css/plugins/validform/style.css" />
<link rel="stylesheet" type="text/css" href="/ui/css/plugins/zTree_v3/zTreeStyle/zTreeStyle.css" />
<link rel="stylesheet" type="text/css" href="/ui/css/vendor.css" rel="stylesheet" />
<link rel="stylesheet" type="text/css" href="/ui/jquery-easyui-1.3.3/themes/default/easyui.css" />
<link rel="stylesheet" type="text/css" href="/ui/jquery-easyui-1.3.3/themes/icon.css" />
<link rel="stylesheet" type="text/css" href="/ui/js/plugins/fancybox/jquery.fancybox.css" />


</head>
<body>
	<div class="wrapper wrapper-content">
		<ol class="breadcrumb">
			您的位置
			<li><a href="/index.html">主页</a></li>
			<li class="active">系统管理</li>
			<li class="active">资源管理</li>
		</ol>
		<div class="container">
		<div class="row">
			<div class="col-sm-12">
				<div class="ibox float-e-margins">
					<div class="ibox-title">
						<h5>
							<i class="fa fa-building-o"></i>系统管理 / 资源管理
						</h5>
						<div class="ibox-tools">
							<a class="collapse-link"> <i class="fa fa-chevron-up"></i>
							</a> <a class="close-link"> <i class="fa fa-times"></i>
							</a>
						</div>
					</div>
					<div class="ibox-content">
						<div class="row">
							<div class="col-sm-4">
								<ul id="resource_view" class="ztree"></ul>
							</div>
							<div class="col-sm-8">
								<form id="resource_form"  action="#" class="form-horizontal">
									<div class="form-body">
										<input type="hidden" id="resourcesId" />
										<input type="hidden" id="resourcesParentId"/>
										<div class="form-group">
											<label class="col-md-3 control-label">资源名称</label>
											<div class="col-md-5">
												<input type="text" value="" id="resourcesName"  class="form-control input-sm"  
													ajaxurl="/sys/resources/checkUserName" name="resourcesName" 
												placeholder="" maxlength="16"  datatype="*2-16" nullmsg="请输入资源名称,2~16字！" errormsg="请输入资源名称,2~16字！"/>
											</div>
											<div class="Validform_checktip"></div>
										</div>
										
										<div class="form-group">
											<label class="col-md-3 control-label">资源类型</label>
											<div class="col-md-5">
												<input id="oldResourcesType" type="hidden" />
 												<select  id="resourcesType" class="form-control input-sm">
 													<option value="1">菜单</option>
													<option value="2">按钮</option>
												</select>
											</div>
											<div class="Validform_checktip"></div>
										</div>
										
										<div class="form-group">
											<label class="col-md-3 control-label">所属系统</label>
											<div class="col-md-5">
 												<select  id="resourcesSysType" class="form-control input-sm" disabled="disabled">
												<#list   systemTypes as systemType >	
													<option value="${systemType.sysValue}">${systemType.sysName}</option>
												</#list>
												</select>
											</div>
											<div class="Validform_checktip"></div>
										</div>
										
										
										<div class="form-group">
											<label class="col-md-3 control-label">是否是末节点</label>
											<input id="resourcesIsEnd" type="hidden" />
											<div class="col-md-5">
												<div class="radio-list">
													<label class="radio-inline">
														<input type="radio" value="1" name="resourcesIsEnd" class="i-checks"  />是
													</label>
													<label class="radio-inline">
														<input type="radio" value="0" name="resourcesIsEnd" class="i-checks"  />否 
													</label>
												</div>
											</div>
											<div class="Validform_checktip"></div>
										</div>
										
										<div class="form-group">
											<label class="col-md-3 control-label">是否启用</label>
											<input id="oldResourcesIsUse" type="hidden" />
											<div class="col-md-5">
												<div class="radio-list">
													<label class="radio-inline">
														<input type="radio" value="1" name="resourcesIsUse" class="i-checks"  />启用
													</label>
													<label class="radio-inline">
														<input type="radio" value="0" name="resourcesIsUse" class="i-checks"  />停用 
													</label>
												</div>
											</div>
											<div class="Validform_checktip"></div>
										</div>
										
										

										<div class="form-group">
											<label class="col-md-3 control-label">访问路径</label>
											<div class="col-md-5">
												<input type="text" class="form-control input-sm" placeholder="" id="resourcesUrl"/>
											</div>
											<div class="Validform_checktip"></div>
										</div>

										<div class="form-group">
											<label class="col-md-3 control-label">资源描述</label>
											<div class="col-md-5">
												<textarea id="resourcesDescription" class="form-control input-sm" rows="3"></textarea>
											</div>
										</div>

										<div class="form-actions">
											<div class="row">
												<div class="col-md-offset-3 col-md-9">
													<button id="moveUp" type="button" class="btn btn-default">&lt;</button>
													<button id="moveUpTop" type="button" class="btn btn-default">&lt;&lt;</button>
													<button id="moveDownBottom" type="button" class="btn btn-default">&gt;&gt;</button>
													<button id="moveDown" type="button" class="btn btn-default">&gt;</button>
												</div>
											</div>
											<div class="row">
												&nbsp;
											</div>
											<div class="row">
												<div class="col-md-offset-3 col-md-9">
													<@auth  url='/sys/resources/update'>
														<button id="btnUpdate" type="submit" class="btn btn-default"><i class="fa fa-save"></i>保存</button>
													</@auth>
													
													<@auth  url='/sys/resources/forInsert'>
														<button id="btnAdd" type="button" class="btn btn-default"><i class="fa fa-plus-square"></i>新增</button>

													</@auth>
													
													<@auth  url='/sys/resources/delete'>
														<button id="btnDelete" type="button" class="btn btn-default"><i class="fa fa-trash-o"></i>删除</button>
													</@auth>
												</div>
											</div>
										</div>
									</div>
								</form>

							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		</div>
	</div>
	
	<script type="text/javascript" src="/ui/js/vendor.js"></script>
	<script type="text/javascript" src="/ui/js/plugins/grid/grid.zh-CN.min.js"></script>
	<script type="text/javascript" src="/ui/js/plugins/grid/bsgrid.all.min.js"></script>
	<script type="text/javascript" src="/ui/js/plugins/validform/Validform_v5.3.2_min.js"></script>
	<script type="text/javascript" src="/ui/js/plugins/layerui/layer/layer.js"></script>
 	<script type="text/javascript" src="/ui/jquery-easyui-1.3.3/jquery.easyui.min.js"></script>
	<script type="text/javascript" src="/ui/js/custom/custom.js"></script>
	<script type="text/javascript" src="/ui/js/plugins/metisMenu/jquery.metisMenu.js"></script>
	
	<script type="text/javascript">

	$(function(){
		
		//初始化tree
		$("#resource_view").tree({
			url:"/sys/resources/tree",
			checkbox:false,
			onBeforeSelect:function(node){
				//if(node.id==1){
					//return false;
				//}
			},
			onSelect:function(node){
				$.ajax({
					type : "GET",
					url : "/sys/resources/find?id="+node.id,
					dataType : "json",
					success : function(data) {
						setEntity(data);
					}
				 });
			},
			loadFilter: function(data){
		 		//过滤
				return treeResolver(data,"1");
		    } 
		});
		
		
		
		var treeResolver=function(data,topNodeId)
		{
			var result =[];
			parseChildren(data);
			if(data.id==topNodeId)
			{
				result.push(data);
			}else if(data instanceof Array){
				result = data;
			}else
			{
				result=data.children;
			}
		   	return result;
		};
		
		/**
		 * 处理服务器返回的树形节点
		 */
		var parseChildren = function(data,topNodeId) {
			if (data.childSize > 0 && data.children.length == 0) {
				data.state = "closed";
			}
			if(data.children&&data.children.length>0)
			for ( var i = 0; i < data.children.length; i++) {
				parseChildren(data.children[i]);
			}
		};
		
		
		
		//定义该变量用于存储客户端资源排序信息
		var ResourcesSort=function()
		{
			var sortMap=[];
			this.add= function(resourcesId,resourcesSortId)
			{
				for(var index=0;index < sortMap.length;index++)
				{
					var map = sortMap[index];
					//如果srotMap中已存在,更新排序号
					if(map["resourcesId"]==resourcesId)
					{
						map["resourcesSortId"]=resourcesSortId;
						return;
					}
				}
				var model ={"resourcesId":resourcesId,"resourcesSortId":resourcesSortId};
				sortMap.push(model);
			};
			this.getSortMap= function(){
				return sortMap;
			};
			this.clear= function(){
				sortMap=[];
			};
		};
		var sortContainer = new ResourcesSort();
		
		$("#moveUp").bind("click",function(){
			var _selected = $("#resource_view").tree("getSelected");
			if(!_selected)
			{
				layer.msg("点击左侧资源视图选择你要操作的资源!");
				return;
			}
			var $current =$(_selected.target.parentNode);
			var $prev =$(_selected.target.parentNode).prev();
			if($prev.length==0)
			{
				layer.msg("该节点已移至顶部，不能再进行移动!");
				return;
			}
			_selected.attributes.resourcesSortId=_selected.attributes.resourcesSortId-1;
			var _prevNode =$("resource_view").tree("getData",$prev.children()[0]);
			_prevNode.attributes.resourcesSortId=_prevNode.attributes.resourcesSortId+1;
			$current.insertBefore($prev);
			sortContainer.add(_selected.id,_selected.attributes.resourcesSortId);
			sortContainer.add(_prevNode.id,_prevNode.attributes.resourcesSortId);
		});
		
		$("#moveUpTop").bind("click",function(){
			var _selected = $("#resource_view").tree("getSelected");
			if(!_selected)
			{
				layer.msg("点击左侧资源视图选择你要操作的资源!");
				return;
			}
			var $prev =$(_selected.target.parentNode).prevAll();
			if($prev.length==0)
			{
				layer.msg("该节点已移至顶部，不能再进行移动!");
				return;
			}
			_selected.attributes.resourcesSortId=1;
			for(var i=0;i<$prev.length;i++)
			{
				var preNode=$("resource_view").tree("getData",$prev[i].children[0]);
				preNode.attributes.resourcesSortId=preNode.attributes.resourcesSortId+1;
				sortContainer.add(preNode.id,preNode.attributes.resourcesSortId);
			}
			sortContainer.add(_selected.id,_selected.attributes.resourcesSortId);
			$(_selected.target.parentNode).insertBefore($(_selected.target.parentNode).parent().find("li:first"));
		});
		
		$("#moveDownBottom").bind("click",function(){
			var _selected = $("#resource_view").tree("getSelected");
			if(!_selected)
			{
				layer.msg("点击左侧资源视图选择你要操作的资源!");
				return;
			}
			var $nextAll =$(_selected.target.parentNode).nextAll();
			if($nextAll.length==0)
			{
				layer.msg("该节点已移至底部，不能再进行移动!");
				return;
			}
			var childrenLength = $(_selected.target.parentNode).siblings().length;
			var  $last =$(_selected.target.parentNode).parent().children()[childrenLength];

			
// 			$last =$(_selected.target.parentNode).parent().find("li:last");
			var lastNode =$("resource_view").tree("getData",$last.children[0]);
			_selected.attributes.resourcesSortId=lastNode.attributes.resourcesSortId;
			
			
			for(var i=0;i<$nextAll.length;i++)
			{
				var nextNode=$("resource_view").tree("getData",$nextAll[i].children[0]);
				nextNode.attributes.resourcesSortId=nextNode.attributes.resourcesSortId-1;
				sortContainer.add(nextNode.id,nextNode.attributes.resourcesSortId);
			}
			sortContainer.add(_selected.id,_selected.attributes.resourcesSortId);
			$(_selected.target.parentNode).insertAfter($last);
		});
		
		$("#moveDown").bind("click",function(){
			var _selected = $("#resource_view").tree("getSelected");
			if(!_selected)
			{
				layer.msg("点击左侧资源视图选择你要操作的资源!");
				return;
			}
			var $current =$(_selected.target.parentNode);
			var $next =$(_selected.target.parentNode).next();
			if($next.length==0)
			{
				layer.msg("该节点已移至底部，不能再进行移动!");
				return;
			}
			$current.insertAfter($next);
			_selected.attributes.resourcesSortId=_selected.attributes.resourcesSortId+1;
			var _nextNode =$("resource_view").tree("getData",$next.children()[0]);
			_nextNode.attributes.resourcesSortId=_nextNode.attributes.resourcesSortId-1;
			
			sortContainer.add(_selected.id,_selected.attributes.resourcesSortId);
			sortContainer.add(_nextNode.id,_nextNode.attributes.resourcesSortId);
			
		});
		

		

		

		
		$("#btnAdd").bind("click",function(){
			var $selected =$("#resource_view").tree("getSelected");
			//未选择任何节点
			if(!$selected)
			{
				layer.msg("点击左侧资源视图选择你要操作的资源!");
				return;
			}
			//末子节点下不能再 创建子节点
			if($("#resourcesIsEnd").val()==1){
				layer.msg("不能在末节点下创建子节点!");
				return;
			}
			if($("#oldResourcesType").val()==2){
				layer.msg("不能在按钮下创建子节点!");
				return;
			}
			
			
			var url ="/sys/resources/forInsert?resourceId="+$selected.id;
			layer.open({
			    type: 2,
			    title: '新增资源',
			    shadeClose: true,
			    maxmin: true, //开启最大化最小化按钮
			    shade: 0.8,
			    area: ['680px', '99%'],
			    content: url //iframe的url
			}); 
			
		});
		
		$("#btnDelete").bind("click",function(){
			var $selected =$("#resource_view").tree("getSelected");
			//未选择任何节点
			if(!$selected)
			{
				layer.msg("点击左侧资源视图选择你要操作的资源!");
				return;
			}
			
			
    		layer.confirm("确定要删除该资源信息吗?", {icon: 3, title:'提示'}, 
    				function(index){
		    			var url ="/sys/resources/delete?resourcesId="+$selected.id;
		    			$.ajax({
		    				url : url,
		    				dataType : "json",
		    				success : function(data) {
		    					layer.msg(data.info);
		
		    					if(data.status==1){
		    						$("#resourcesDescription").text("");
		    						$('#resource_form')[0].reset();
		    						window.setTimeout(function(){
		    							$("#resource_view").tree("remove",$selected.target);
		    						},400);
		    					}
		    				}
		    			 });
    			});
			
			
			

		});
		
		//register callback after add execute!
		window.saveCallBack = function(_data){
			var _selected = $("#resource_view").tree("getSelected");
			if(_selected.state=="closed"){
				$('#resource_view').tree("expand",_selected.target);
			}else
				{
					$('#resource_view').tree('append', {
						parent: _selected.target,
						data: [{
							id: _data.data.resourcesId,
							text: _data.data.resourcesName,
							children:[],
							state:"open",
							attributes:[{"resourcesSortId":_data.data.resourcesSortId}]
						}]
					});
				}
		};
		
		
		var submitHtml = $('#btnUpdate').html();
		var resource_form = $('#resource_form').Validform({
			tiptype:function(msg,o,cssctl){
				if(!o.obj.is("form")){
					var objtip=o.obj.parent().siblings(".Validform_checktip");
					cssctl(objtip,o.type);
					objtip.text(msg);
				}
			},
			callback:function($form){
				submitToggle(1,submitHtml);
				var model ={};
				model.resources = {};
				model.resources.resourcesId =$("#resourcesId").val();
				model.resources.resourcesParentId =$("#resourcesParentId").val();
				model.resources.resourcesName =$("#resourcesName").val();
				model.resources.resourcesIsUse =$('input[name="resourcesIsUse"]:checked').val();
				model.resources.resourcesUrl =$("#resourcesUrl").val();
				model.resources.resourcesDescription =$("#resourcesDescription").val()||$("#resourcesDescription").text();
				
				model.resources.resourcesType=$("#resourcesType").val();
				model.resources.resourcesSysType=$("#resourcesSysType").val();
				model.resources.resourcesIsEnd =$('input[name="resourcesIsEnd"]:checked').val();
				
 				model.resourcesSortable=sortContainer.getSortMap();

				var $selected =$("#resource_view").tree("getSelected");
				//未选择任何节点
				if(!$selected)
				{
					layer.msg("点击左侧资源视图选择你要操作的资源!");
					submitToggle(0,submitHtml);
					return false;
				}
				
				if($('input[name="resourcesIsUse"]:checked').val()!=$("#oldResourcesIsUse").val()){
				
	    		layer.confirm("您修改了启用状态，修改父级启用状态将影响子级，确认修改吗?", {icon: 3, title:'提示'}, 
	    				function(index){
	    					update(model,$selected);
	    			});
					submitToggle(0,submitHtml);

				}else{
					update(model,$selected);
				}
				//表单验证通过进行回掉处理
				return false;
			}
		});
		
		/** 设置保存方法 */
		function update(model,$selected){
			$.ajax({
	            type: "POST",
	            url: "/sys/resources/update",
	            data: JSON.stringify(model),
	            contentType:"application/json",
	            dataType: "json",
	            success: function(data){
	            		layer.msg(data.info);
					submitToggle(0,submitHtml);
	           		
					$selected.text=data.data.resourcesName;
					$("#resource_view").tree("update",$selected);
					//清空排序信息数组
					sortContainer.clear();
 					setEntity(data.data);

				},
				error:function(data) {
				}
	        });
		}
		
		/** 设置实体 */
		function setEntity(data){
			
 			$("#resourcesDescription").text(data.resourcesDescription==null?"":data.resourcesDescription);
			$("#resourcesUrl").val(data.resourcesUrl);
			
			$('input[name="resourcesIsUse"][value="'+data.resourcesIsUse+'"]').iCheck('check');
			$("#oldResourcesIsUse").val(data.resourcesIsUse);
			
			$("#resourcesName").val(data.resourcesName);
			$("#resourcesName").attr("name",data.resourcesName);

			$("#resourcesId").val(data.resourcesId);
			$("#resourcesParentId").val(data.resourcesParentId);
			
			
			$("#resourcesIsEnd").val(data.resourcesIsEnd);
				if(data.resourcesIsEnd!=null){
				$('input[name="resourcesIsEnd"][value="'+data.resourcesIsEnd+'"]').iCheck('check');
			}else{
				$('input[name="resourcesIsEnd"]').iCheck('uncheck');
			}

			
			//资源类型
			$("#oldResourcesType").val(data.resourcesType);
			if(data.resourcesType !=null){
				$("#resourcesType").val(data.resourcesType);
			}else{
				$("#resourcesType").val(0);
			}
			
			if(data.resourcesSysType !=null){
				$("#resourcesSysType").val(data.resourcesSysType);
			}else{
				$("#resourcesSysType").val(0);
			}
			
			if(data.resourcesParentId ==null){
				$("#resourcesSysType").val(data.resourcesSysType);
				}
		}
		
		/** 设置提交提示信息 */
		function submitToggle(status, submitHtml) {
			if (status == 0) {
				$('#btnUpdate').html(submitHtml).attr('disabled', false);
			} else {
				$('#btnUpdate').html('<i class="fa fa-spin fa-spinner"></i>    正在提交').attr('disabled', true);
			}
		}
		
	});
		
	</script>
</body>
</html>