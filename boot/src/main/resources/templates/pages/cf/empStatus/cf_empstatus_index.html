<!DOCTYPE html>
<@compress single_line=true></@compress>
<html>
<head>
    <#include "/pages/common/head.html" />
    <title>消分员工状态变更</title>
</head>

<body style="padding: 0px; margin: 0px;">
<div class="wrapper wrapper-content">
    <ol class="breadcrumb">
        您的位置：
        <li>
            <a href="/index.html"><i class="layui-icon" style="font-weight: bold;font-size:15px;">&#xe68e;</i>主页</a>
        </li>
        <li class="active">消金考勤管理</li>
        <li class="active">
            <i class="layui-icon" style="font-weight: bold;font-size: 15px;">&#xe62a;</i>
            <font>消分员工状态管理</font>
        </li>
    </ol>
    <div class="ibox float-e-margins">
        <div class="ibox-content">
            <form id="form" class="layui-form" lay-filter="form">
                <div class="container-fluid">
                    <div class="row">
                        <!--员工编码-->
                        <div class="col-lg-3 col-md-4 col-sm-6 col-xs-12">
                            <div class="row">
                                <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 zh-form-lable">
                                    <label>员工编码：</label>
                                </div>
                                <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8 zh-form-content">
                                    <input name="empNo" id="empNo" type="text" class="form-control input-sm"
                                           placeholder="员工编码">
                                </div>
                            </div>
                        </div>
                        <!--员工姓名-->
                        <div class="col-lg-3 col-md-4 col-sm-6 col-xs-12">
                            <div class="row">
                                <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 zh-form-lable">
                                    <label>员工姓名：</label>
                                </div>
                                <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8 zh-form-content">
                                    <input name="empName" id="empName" type="text" class="form-control input-sm"
                                           placeholder="员工姓名">
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-3 col-md-4 col-sm-6 col-xs-12">
                            <div class="row">
                                <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 zh-form-lable">
                                    <label>部门：</label>
                                </div>
                                <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8 zh-form-content">
                                    <input type="hidden" id="newDeptHidden" value="">
                                    <input id="newDept" type="text" class="form-control input-sm" readonly
                                           placeholder="部门">
                                    <input type="hidden" name="otherQuery" id="newDeptActionTypeId"/>
                                    <!--actionTreeContent-->
                                    <div id="newActionTreeContent"
                                         style="width: 300px; border-radius:5px;display: none; z-index:9999;position: absolute; border: 1px #CCC solid; background-color:#f9f9f9;">
                                        <ul id="newActionTypeTree" class="ztree"
                                            style="margin-top:0;height: 200px;overflow: auto;"></ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!--<div class="col-lg-3 col-md-4 col-sm-6 col-xs-12">
                            <div class="row">
                                <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 zh-form-lable">
                                    <label>大区：</label>
                                </div>
                                <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8 zh-form-content">
                                    <select id="deptArea" name="deptArea" lay-search="" lay-filter="deptArea"
                                            placeholder="-请选择-">
                                        <option></option>
                                        <#list  deptArea as bl>
                                            <option value="${bl.id!}">${bl.deptName!}</option>
                                        </#list>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-4 col-sm-6 col-xs-12">
                            <div class="row">
                                <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 zh-form-lable">
                                    <label>分公司：</label>
                                </div>
                                <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8 zh-form-content">
                                    <div class="layui-form-item">
                                        <div class="layui-input-block">
                                            <select id="branch" name="orgNo" lay-search="" lay-filter="orgNo"
                                                    placeholder="-请选择-">
                                                <option></option>
                                                <#list  orgNo as bl>
                                                    <option value="${bl.id!}">${bl.deptName!}</option>
                                                </#list>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-4 col-sm-6 col-xs-12">
                            <div class="row">
                                <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 zh-form-lable">
                                    <label>营业部：</label>
                                </div>
                                <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8 zh-form-content">
                                    <div class="layui-form-item">
                                        <div class="layui-input-block">
                                            <select id="sales" name="salesDept" lay-search="" lay-filter="salesDept"
                                                    placeholder="-请选择-">
                                                <option></option>
                                                <#list  salesDept as bl>
                                                    <option value="${bl.id!}">${bl.deptName!}</option>
                                                </#list>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>-->

                        <div class="col-lg-3 col-md-4 col-sm-6 col-xs-12">
                            <div class="row">
                                <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 zh-form-lable">
                                    <label>开始时间：</label>
                                </div>
                                <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8 zh-form-content">
                                    <input name="startDate" id="start" type="text"
                                           class="layui-input input-sm"
                                           placeholder="-请选择-" value="">

                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-4 col-sm-6 col-xs-12">
                            <div class="row">
                                <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 zh-form-lable">
                                    <label>结束时间：</label>
                                </div>
                                <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8 zh-form-content">
                                    <input name="endDate" id="end" type="text"
                                           class="layui-input input-sm"
                                           placeholder="-请选择-" value="">
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-4 col-sm-6 col-xs-12">
                            <div class="row">
                                <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 zh-form-lable">
                                    <label>状态：</label>
                                </div>
                                <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8 zh-form-content">
                                    <select name="status" id="status" type="text" class="form-control input-sm"
                                            placeholder="-请选择-">
                                        <option></option>
                                        <#list  statusList as bl>
                                            <option value="${bl.sysValue!}">${bl.sysName!}</option>
                                        </#list>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-4 col-sm-6 col-xs-12">
                            <div class="row">
                                <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 zh-form-lable">
                                    <label>是否结束：</label>
                                </div>
                                <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8 zh-form-content">
                                    <select name="isend" id="isend" type="text" class="form-control input-sm"
                                            placeholder="-请选择-">
                                        <option></option>
                                        <#list  isendList as bl>
                                            <option value="${bl.sysValue!}">${bl.sysName!}</option>
                                        </#list>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <!--按钮-->

                        <div class="col-lg-3 col-md-4 col-sm-6 col-xs-12 col-lg-offset-10 col-md-offset-6 col-sm-offset-0 ">
                            <div class="row">
                                <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 zh-form-lable"></div>
                                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 "
                                     style="position: relative;left: -120px;">
                                    <@auth url='/cf/empStatus/list'>
                                    <button lay-submit lay-filter="auditQuery" class="btn btn-primary btn-sm"
                                            type="button" title="查询">
                                        <i class="layui-icon" style="font-size: 15px;">&#xe615;</i>
                                        <font>查询</font>
                                    </button>
                                    </@auth >

                                    <button lay-submit lay-filter="clear" class="btn btn-primary btn-sm"
                                            type="button" title="清除" style="background-color: #935c25">
                                        <i class="layui-icon" style="font-size: 15px;">&#x1002;</i>
                                        <font>清除</font>
                                    </button>

                                    <@auth url='/cf/empStatus/addInit'>
                                    <button class="btn btn-primary btn-sm" lay-submit lay-filter="add"
                                            style="background-color: #FF5722" type="button" title="新增">
                                        <i class="layui-icon" style="font-size: 15px;">&#xe64c;</i>
                                        <font>新增</font>
                                    </button>
                                    </@auth >
                                    <@auth url='/cf/empStatus/importExl'>
                                    <button class="btn btn-primary btn-sm" lay-submit lay-filter="importExl"
                                            style="background-color: #0da3e2" type="button" title="导出">
                                        <i class="layui-icon" style="font-size: 15px;">&#xe654;</i>
                                        <font>导入</font>
                                    </button>
                                    </@auth >
                                    <@auth url='/cf/empStatus/exportExl'>
                                    <button class="btn btn-primary btn-sm" lay-submit lay-filter="exportExl"
                                            style="background-color: #009688" type="button" title="导出">
                                        <i class="layui-icon" style="font-size: 15px;">&#xe601;</i>
                                        <font>导出</font>
                                    </button>
                                    </@auth >
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <!--Grid-->
        <div class="ibox-content">
            <table class="layui-hide" id="transferTable" lay-filter="useruv"></table>
        </div>
    </div>
</div>
<!--上部分查询-->


<div id="importExlDiv" class="wrapper wrapper-content animated fadeInUp" style="padding: 0px;display: none">
    <div class="container-fluid" style="padding: 0px;">
        <div class="ibox-content form">
            <div class="form-body" style="height: 100%;width: 100%">
                <div class="container-fluid">
                    <div class="row layui-form">
                        <form id="addshowForm">
                            <div class="layui-form-item" style="padding-left: 15%;padding-top: 8%;">
                                <label class="layui-form-label" style="width: auto;">导入文件</label>
                                <div class="layui-input-inline">
                                    <button type="button" class="layui-btn layui-btn-sm" id="importCard">
                                        <i class="layui-icon"></i>选择文件
                                    </button>
                                    <span class="layui-required-span" style="color: red">*</span>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <a href="${ctx}/exporTemp/员工导入模板.xls"
                                   style="color: #00acee;padding-left: 32%!important;">员工状态导入模板</a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

</body>
<#include "/pages/common/foot.html" />
<link rel="stylesheet" href="${ctx}/ui/css/plugins/zTree_v3/metroStyle/metroStyle.css" type="text/css">
<script type="text/javascript" src="/ui/easyui-1.5.1/jquery.easyui-1.5.1.min.js"></script>
<script type="text/javascript" src="/ui/easyui-1.5.1/jquery.easyui-1.5.1.min.js"></script>
<script type="text/javascript" src="${ctx}/ui/js/plugins/iCheck/icheck.min.js"></script>
<script type="text/javascript" src="${ctx}/ui/js/plugins/zTree_v3/jquery.ztree.core-3.5.js"></script>
<script type="text/javascript" src="${ctx}/ui/js/plugins/zTree_v3/jquery.ztree.excheck-3.5.js"></script>
<script type="text/javascript" src="${ctx}/ui/js/plugins/zTree_v3/jquery.ztree.exedit-3.5.js"></script>
<script type="text/html" id="tableRowNumTpl">
    {{ d.LAY_TABLE_INDEX+1}}
</script>
<script type="text/html" id="tableRowOperationTpl">
    <@auth url='/cf/empStatus/editInit'>
    <a class="layui-btn layui-btn-radius layui-btn-xs" lay-event="edit">编辑</a>
    </@auth>
    <@auth url='/cf/empStatus/relieve'>
    <a class="layui-btn layui-btn-radius layui-btn-danger layui-btn-xs" lay-event="relieve">解除</a>
    </@auth>
</script>
<script type="text/html" id="statusTpl">

    {{#  if('401' == d.statusName){  }}
    <label>停薪停职</label>
    {{#  } }}

    {{#  if('402' == d.statusName){  }}
    <label>停薪留职</label>
    {{#  } }}
</script>
<script type="text/html" id="businessesListTpl">
    {{#  layui.each(${businesses!}.obj, function(index, item){  }}
    {{#  if(item.posCode == d.jobName){  }}
    {{   item.posName }}
    {{#  return true;  }}
    {{#  } }}
    {{#  });}}
</script>


<script type="text/javascript">


    var setting = {
        view: {
            dblClickExpand: false,
            showLine: false
        },
        data: {
            simpleData: {
                enable: true,
                idKey: "id",
                pIdKey: "pid"
            }
        },
        callback: {
            onClick: onClick
        }
    };

    /*Init Nodes and action*/
    function onClick(e, treeId, treeNode) {
        if (treeId == "newActionTypeTree") {
            $("#newDept").val(treeNode.name);
        }
        tree.getDeptInfo(treeNode.id, treeId);
        //tree.getDeptAndPostByDeptNo(treeNode.id, treeId);
    }

    /*tree*/
    var tree = {
        showActionDeptTree: function (type) {
            $.ajax({
                url: '${ctx}/hqclcf/hqclcfPost/dept/tree',
                type: 'post',
                dataType: "json",
                async: false,
                success: function (data) {
                    /*部门*/
                    if (type == "new") {
                        ztreeObj = $.fn.zTree.init($("#newActionTypeTree"), setting, data);
                        $("#newActionTreeContent").slideDown("fast");
                        var zTree = $.fn.zTree.getZTreeObj("newActionTypeTree");
                        var node = zTree.getNodeByParam("id", $('#newActionTypeId').val(), null);
                        zTree.selectNode(node);
                        $("body").bind("mousedown", onBodyDownByActionType);
                    }
                }
            });
        },
        getDeptAndPostByDeptNo: function (data, type) {
            layui.use(['form'], function () {
                var form = layui.form;
                $.ajax({
                    url: '${ctx}/hqclcf/hqclcfPersonTransfer/deptAndPostByDeptNo',
                    method: 'post',
                    data: {
                        id: data
                    },
                    dataType: 'json',
                    success: function (res) {
                        if (res.code == "200") {
                            if (type == "actionTypeTree") {
                                $('body').find("#busineSelect option").each(function (index, n) {
                                    if ($(this).val() == res.dept.businessLine) {
                                        document.getElementById("busineSelect").value = res.dept.businessLine;
                                        form.render();
                                    }
                                })
                                $("#priPostNo").empty();
                                for (var i = 0; i < res.post.length; i++) {
                                    if (i == 0) {
                                        $("<option></option>").appendTo($("#priPostNo"));
                                    }
                                    $("<option value=" + res.post[i].postNo + ">" + res.post[i].postName + "</option>").appendTo($("#priPostNo"));
                                }
                            }
                            if (type == "newActionTypeTree") {
                                $('body').find("#newBusineSelect option").each(function (index, n) {
                                    if ($(this).val() == res.dept.businessLine) {
                                        document.getElementById("newBusineSelect").value = res.dept.businessLine;
                                        form.render();
                                    }
                                })
                                $("#newPost").empty();
                                for (var i = 0; i < res.post.length; i++) {
                                    if (i == 0) {
                                        $("<option></option>").appendTo($("#newPost"));
                                    }
                                    $("<option value=" + res.post[i].postNo + ">" + res.post[i].postName + "</option>").appendTo($("#newPost"));
                                }
                            }
                            form.render();
                        } else {
                            layer.msg("异常，请确认改部门下是否存在岗位或岗位异常", {icon: 3, time: 1500});
                        }

                    }
                })
            })
        },
        getDeptInfo: function (deptPriNumber, type) {
            $.ajax({
                url: '${ctx}/hqclcf/hqclcfPost/dept/businessLine',
                data: {
                    id: deptPriNumber
                },
                type: 'POST',
                dataType: "json",
                async: false,
                success: function (data) {
                    var code = data.deptCode;
                    if (type == "actionTypeTree") {
                        $("#actionTypeId").val(code);
                    }
                    if (type == "newActionTypeTree") {
                        $("#newDeptActionTypeId").val(data.id);
                        $("#newDeptHidden").val(data.id);
                    }
                }
            });
        }


    }

    var table;
    var form;
    var laydate;
    var upload;
    var uploadIndex;

    /*初始化*/
    layui.use(['table', 'laydate', 'form', 'upload'], function () {
        table = layui.table;
        form = layui.form;
        laydate = layui.laydate;
        upload = layui.upload;

        form.render();
        table.render({
            elem: '#transferTable',
            id: 'id',
            url: '${ctx}/cf/empStatus/list',
            loading: true,
            method: 'post',
            cols: [[
                {width: 70, fixed: true, title: '序号', align: 'center', sort: true, templet: '#tableRowNumTpl'},
                {field: 'empNo', title: '员工编码', width: 140, align: 'center'},
                {field: 'empName', title: '员工姓名', width: 120, align: 'center'},
                {field: 'deptArea', title: '大区', width: 160, align: 'center'},
                {field: 'orgNo', title: '分中心', width: 150, align: 'center'},
                {field: 'salesDept', title: '营业部', width: 150, align: 'center'},
                {field: 'deptCode', title: '团队', width: 100, align: 'center'},
                {field: 'jobName', title: '职位', width: 150, align: 'center'},
                {field: 'statusName', title: '状态', width: 80, align: 'center', templet: '#statusTpl'},
                {field: 'startDate', title: '开始时间', width: 120, align: 'center'},
                {field: 'endDate', title: '结束时间', width: 120, align: 'center'},
                {field: 'remark', title: '描述', width: 600, align: 'center'},
                {fixed: 'right', title: '操作', width: 150, align: 'center', toolbar: '#tableRowOperationTpl'}
            ]],
            height: '500',
            skin: 'row',
            size: 'sm',
            even: true,
            page: true,
            limits: [10, 30, 50],
            limit: 10
        });

        upload.render({
            elem: '#importCard',
            accept: 'file',
            exts: 'xls',
            url: '${ctx}/cf/empStatus/importExl',
            before:function(){
                uploadIndex = layer.load(2);
            },
            done: function (res) {

                layer.close(uploadIndex);

                if (res.code == 200) {
                    layer.close(importIndex);
                    layer.msg("导入成功！", {icon: 6});
                    setTimeout(
                        function () {
                            var url = "${ctx}/cf/empStatus/init";
                            window.location.href = url;
                        }, 1000);
                } else {
                    layer.tips(res.msg, '#importCard');
                }
            },
            error: function (res,e) {
                layer.close(uploadIndex);
                layer.tips(res.msg, '#importCard');
            }
        });

        /*查询*/
        form.on('submit(auditQuery)', function (obj) {
            table.reload('id', {
                where: obj.field || {}
            })
        });
        /*导出员工状态变更信息*/
        form.on('submit(exportExl)', function () {
            window.location = '${ctx}/cf/empStatus/exportExl?' + $("#form").serialize();
            return false;
        });

        /*导入员工状态变更信息*/
        form.on('submit(importExl)', function () {

            importIndex = layer.open({
                type: 1,
                title: ['<b>员工状态导入</b>', 'font-size:15px;text-align:center;'],
                content: $('#importExlDiv'),
                area: ['400px', '200px'],
                btnAlign: 'c',
                anim: 2,
                yes: function (index, layero) {

                }, btn2: function (index, layero) {
                    layer.close(index);
                }, cancel: function (index) {
                    layer.close(index);
                }
            });

        });

        /*清除*/
        form.on('submit(clear)', function (obj) {

            $("#form").find("input,select").each(function (index, n) {
                $(this).val("");
            })
            $("#postNo").find("option").each(function (priIndex, n2) {
                $(n2).remove();
            })
            form.render();

        });

        /*新增*/
        form.on('submit(add)', function (obj) {

            var editLayer = layer.open({
                type: 2,
                title: '您的位置：消分考勤统计>员工状态变更管理>新增',
                btnAlign: 'c',
                resize: false,
                skin: '',
                area: ['53%', '55%'],
                content: ['${ctx}/cf/empStatus/addInit', 'yes'],
                btn: ['新增', '取消'],
                yes: function (index, layero) {

                    var iframeWin = window[layero.find('iframe')[0]['name']];
                    /**/
                    if (iframeWin.validateEmpStatusfer()) {
                        var form = layer.getChildFrame('form', index);
                        var obj = $.fn.serializeObject($(form));
                        $.ajax({
                            url: '${ctx}/cf/empStatus/add',
                            data: {"data": JSON.stringify(obj)},
                            type: 'post',
                            async: false,
                            dataType: 'json',
                            success: function (res) {
                                if (res.code == '200') {
                                    layer.msg("新增成功", {icon: 6, time: 1500}, function () {
                                        table.reload('id', {
                                            where: obj.field || {}
                                        })
                                        layer.closeAll();
                                    });
                                } else {
                                    layer.msg("新增失败：" + res.msg, {icon: 5, time: 1500});
                                }
                            },
                            error: function () {
                                layer.msg("异常,请稍后重试！：" + res.msg, {icon: 5, time: 1500});
                            }
                        });

                        layer.close(index);
                    }

                }
            }, function () {
                form.render();
            });

        });

        /*解除修改*/
        table.on('tool(useruv)', function (obj) {
            var data = obj.data;
            if (obj.event === 'relieve') {
                var oepnIndex = layer.open({
                    title: '您的位置：消金考勤统计>消分员工状态管理>设置结束时间',
                    btnAlign: 'c',
                    resize: false,
                    area: ['35%', '21%'],
                    content: "<table style='width:80%';display: inline-block;' class='layer-table table-style'><tr style='text-align: center;'><td>结束时间:</td><td><input type='text' id='endTime' placeholder='请选择结束时间' class='form-control' style='align:center;margin-left:10%;display: inline-block;'></td><td><span style='color:red;'>*</span></td></tr></table> ",
                    btn: ['确定', '取消'],
                    yes: function () {
                        layer.close(oepnIndex);
                        var indexLoad;

                        var endTime = $('#endTime').val();
                        if (endTime != '' && endTime != null) {


                            var start = data.startDate.replace('-','/');
                            var beginDate =  new Date(start);

                            endTime =   endTime.replace('-','/');
                            var enterDate = new Date(endTime);


                            if(enterDate!="" && enterDate < beginDate)
                            {
                                layer.msg("<font style='color: paleturquoise'>" + '解除时间' + "</font>" + "不能小于开始时间", {
                                    anim: 6,
                                });
                                return;
                            }



                            $.ajax({
                                url: '${ctx}/cf/empStatus/relieve',
                                data: {
                                    priNumber: data.priNumber,
                                    endDate: $('#endTime').val()
                                },
                                type: 'post',
                                dataType: 'json',
                                beforeSend: function () {
                                    indexLoad = layer.load(2);
                                },
                                success: function (msg) {

                                    layer.close(indexLoad);
                                    if (msg.code == "200") {
                                        layer.msg("设置成功!", {icon: 6});
                                        table.reload('id', {
                                            where: obj.field || {}
                                        })
                                    } else {
                                        layer.msg("设置失败! " + msg.msg, {icon: 5});
                                    }
                                },
                                error: function (msg) {
                                    layer.close(indexLoad);
                                    layer.msg("设置出现异常，请稍后重试! ", {icon: 5});
                                }

                            })
                        } else {
                            layer.msg("结束时间设置不合法！", {icon: 5, time: 1500});
                            return;
                        }

                    },
                    success: function () {
                        /*日期控件*/
                        laydate.render({
                            elem: '#endTime',
                            theme: '#393D49',
                            type: 'date'
                        });
                        layer.close(oepnIndex);
                        form.render();
                    },
                    cancel: function () {
                        layer.close(oepnIndex);
                    },
                    error: function () {
                        console.log('打开面板异常...');
                    }

                })

            } else if (obj.event === 'edit') {

                var endDate = data.endDate;

                if (endDate == null || endDate == '') {

                    var editLayer = layer.open({
                        type: 2,
                        title: '您的位置：消分考勤统计>员工状态变更管理>编辑',
                        btnAlign: 'c',
                        resize: false,
                        skin: '',
                        area: ['60%', '50%'],
                        content: ['${ctx}/cf/empStatus/editInit?id=' + data.priNumber, 'yes'],
                        btn: ['修改', '取消'],
                        yes: function (index, layero) {

                            var iframeWin = window[layero.find('iframe')[0]['name']];
                            /**/
                            if (iframeWin.validateEmpStatusfer()) {
                                var form = layer.getChildFrame('form', index);
                                var obj = $.fn.serializeObject($(form));
                                $.ajax({
                                    url: '${ctx}/cf/empStatus/edit',
                                    data: {"data": JSON.stringify(obj)},
                                    type: 'post',
                                    async: false,
                                    success: function (res) {
                                        if (res.code == '200') {
                                            layer.msg("修改成功", {icon: 6, time: 1500}, function () {
                                                table.reload('id', {
                                                    where: obj.field || {}
                                                })
                                                layer.closeAll();
                                            });
                                        } else {
                                            layer.msg("修改失败：" + res.msg, {icon: 5, time: 1500});
                                        }
                                    },
                                    error: function () {
                                        layer.msg("网络通信异常," + res.msg, {icon: 5, time: 1500});
                                    }
                                });

                                layer.close(index);
                            }

                        }
                    }, function () {
                        form.render();
                    });

                } else {
                    layer.msg("此记录已结束，不允许修改！", {time: 1500, icon: 5});
                    return;
                }

            }
        });

        /*大区下拉*/
        form.on('select(deptArea)', function (data) {
            selectThisval(data.value, 1);
        });
        /* 分公司*/
        form.on('select(orgNo)', function (data) {
            selectThisval(data.value, 2);
        });
        /* 营业部*/
        form.on('select(salesDept)', function (data) {
            selectThisval(data.value, 3);
        });
    });

    $(document).ready(function () {

        layui.use(['table', 'laydate', 'form'], function () {

            laydate = layui.laydate;
            form = layui.form;
            table = layui.table;

            /*日期控件*/
            laydate.render({
                elem: '#start',
                theme: '#393D49',
                type: 'date'
            });
            /*日期控件*/
            laydate.render({
                elem: '#end',
                theme: '#393D49',
                type: 'date'
            });

            form.render();

        })

        /*DeptTree*/
        $("#newDept").click(function () {
            tree.showActionDeptTree("new");
        })

    })


    /*
     * Body鼠标按下事件回调函数
     */
    function onBodyDownByActionType(event) {
        if (event.target.id.indexOf('switch') == -1 && event.target.id != 'actionTypeTree') {
            hideActionTypeMenu();
        }
    }

    function selectThisval(obj, type) {
        $.ajax({
            url: '${ctx}/cf/cardAbnormity/buildDeptSelect',
            type: 'POST',
            dataType: "json",
            async: false,
            data: {"id": obj},
            success: function (data) {
                console.log(data);
                switch (type) {
                    case 1:
                        $("#branch").val(data.orgId);
                        $("#sales").val(data.saleId);
                        break;
                    case 2:
                        $("#deptArea").val("");
                        $("#sales").val(data.saleId);
                        break;
                    case 3:
                        $("#deptArea").val("");
                        $("#branch").val("");
                        break;
                }
                form.render("select");
            }
        });
    }

    /*
     * 隐藏点击事件Tree
     */
    function hideActionTypeMenu() {
        $("#actionTreeContent").fadeOut("fast");
        $("#newActionTreeContent").fadeOut("fast");
        $("body").unbind("mousedown", onBodyDownByActionType);
    }

</script>
</html>
