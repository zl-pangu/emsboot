<@compress single_line=true>
<!DOCTYPE html>
<html>
<head>
<title>用户管理-用户详细</title>
  <#include "/pages/common/head.html" >
<style type="text/css">
.my_lebel {
	width: 20%;
	text-align: right;
	padding-right: 10px;
}

.my_content {
	width: 30%;
}

.my_cb {
	width: 10%;
	text-align: right;
	padding-right: 5px;
}

.my_cb_title {
	width: 20%;
	cursor: default;
}

.my_td_select {
  width: 20%;
  height: 75px;
  margin: 0 auto;
  vertical-align: middle !important;
  text-align: center ;
}

.my_td_selectLeft {
  width: 100%;
  height: 75px;
  margin: 0 auto;
  vertical-align: middle !important;
  text-align: left;
}
  #form .layui-input-block{
    padding: inherit;
  }

#form  .layui-layer-hui .layui-layer-content {
  padding: 7px 25px;
  margin-top: 1px;
  text-align: center;
  background-color: black;
}
#form .textbox-text,.validatebox-text,.textbox-prompt{
  margin: 0px 28px 0px 0px;
  padding-top: 0px;
  padding-bottom: 0px;
  height: 24px;
  line-height: 24px;
}
</style>
</head>
<body style="margin: 0px; padding: 10px;">
  <#if type == "show">
    <form id="form" class="layui-form">
      <div class="ibox-content" style=" padding: 10px; overflow: auto;">
      <table style="border-collapse: separate; border-spacing: 0px 5px; width:750px;">
      <tr>
        <td class="my_lebel">
          <label class="control-label">登录名</label>
        </td>
        <td class="my_content">
          <input type="text" class="form-control input-sm" value="${user.userName!}" disabled="disabled" />
        </td>
      </tr>
      <tr>
        <td class="my_lebel">
          <label class="control-label">真实姓名</label>
        </td>
        <td class="my_content">
          <input type="text" class="form-control input-sm" value="${user.fullName!}" disabled="disabled" />
        </td>
        <td class="my_lebel">
          <label class="control-label">电话号码</label>
        </td>
        <td class="my_content">
          <input type="text" class="form-control input-sm" value="${user.teleNum!}" disabled="disabled" />
        </td>
      </tr>
      <tr>
        <td class="my_lebel">
          <label class="control-label">手机</label>
        </td>
        <td class="my_content">
          <input type="text" class="form-control input-sm" value="${user.mobile!}" disabled="disabled" />
        </td>
        <td class="my_lebel">
          <label class="control-label">E-mail</label>
        </td>
        <td class="my_content">
          <input type="text" class="form-control input-sm" value="${user.email!}" disabled="disabled" />
        </td>
      </tr>
      <tr>
        <td class="my_lebel">
          <label class="control-label">员工编号</label>
        </td>
        <td class="my_content">
          <input type="text" class="form-control input-sm" value="${user.empNo!}" disabled="disabled" />
        </td>
        <td class="my_lebel">
          <label class="control-label">是否有效</label>
        </td>
        <td class="my_content">
          <#if user.isEnable == 1>
            <input type="text" class="form-control input-sm" value="有效" disabled="disabled" />
            <#elseif user.isEnable == 0>
              <input type="text" class="form-control input-sm" value="无效" disabled="disabled" />
              <#else>
                <input type="text" class="form-control input-sm" value="${user.isEnable!}" disabled="disabled" />
          </#if>
        </td>
      </tr>
      <tr>
        <td class="my_lebel">
          <label class="control-label">最后登录时间</label>
        </td>
        <td class="my_content">
          <input type="text" class="form-control input-sm" value="${(user.lastLoginTime?string('yyyy-MM-dd HH:mm:ss'))!}" disabled="disabled" />
        </td>
        <td class="my_lebel">
          <label class="control-label">最后改密时间</label>
        </td>
        <td class="my_content">
          <input type="text" class="form-control input-sm" value="${(user.lastChangePwdTime?string('yyyy-MM-dd HH:mm:ss'))!}" disabled="disabled" />
        </td>
      </tr>
      <tr>
        <td class="my_lebel">
          <label class="control-label">创建者</label>
        </td>
        <td class="my_content">
          <input type="text" class="form-control input-sm" value="${user.creatorUserId!}" disabled="disabled" />
        </td>
        <td class="my_lebel">
          <label class="control-label">创建时间</label>
        </td>
        <td class="my_content">
          <input type="text" class="form-control input-sm" value="${(user.createTime?string('yyyy-MM-dd HH:mm:ss'))!}" disabled="disabled" />
        </td>
      </tr>
      <tr>
        <td class="my_lebel">
          <label class="control-label">修改者</label>
        </td>
        <td class="my_content">
          <input type="text" class="form-control input-sm" value="${user.updateUserId!}" disabled="disabled" />
        </td>
        <td class="my_lebel">
          <label class="control-label">修改时间</label>
        </td>
        <td class="my_content">
          <input type="text" class="form-control input-sm" value="${(user.updateTime?string('yyyy-MM-dd HH:mm:ss'))!}" disabled="disabled" />
        </td>
      </tr>
      <tr>
        <td class="my_lebel">
          <label class="control-label">权限范围</label>
        </td>
        <td class="my_content" colspan="4">
          <div style="border: 1px solid rgba(0, 0, 0, .3); border-radius: 3px; height: 300px;">
            <table class="table table-bordered ">
              <tbody>
              <tr>
                <td class="my_td_select">
                  <div class="layui-form-item" pane="">
                    <#assign myflag=0>
                      <#list blList as bl>
                        <#if (bl==0)>
                          <#assign myflag=1>
                            <#break/>
                        </#if>
                      </#list>
                      <#if myflag=1>
                        <input  lay-skin="primary" id="allBl" disabled="disabled" name="blSelect" checked lay-filter="allBlSelect" value="0" title="全部" type="checkbox" >
                        <#else>
                          <input  lay-skin="primary" id="allBl" disabled="disabled" name="blSelect" lay-filter="allBlSelect" value="0" title="全部" type="checkbox" >
                      </#if>
                  </div>
                </td>
                <td class="my_td_selectLeft">
                  <label class="layui-form-label" style="margin: 6px;width: auto;">部门</label>
                  <div class="layui-input-inline">
                    <input id="allInputId" value="${allInput!}"  class="layui-input" style="margin: 10px;width: auto;" disabled="disabled"/>
                  </div>
                </td>
              </tr>
              <tr>
                <td  class="my_td_select"/>
                <div class="layui-form-item" pane="">
                  <#assign myflag=0>
                    <#list blList as bl>
                      <#if (bl==1)>
                        <#assign myflag=1>
                          <#break/>
                      </#if>
                    </#list>
                    <#if myflag=1>
                      <input  lay-skin="primary" id="hqBl" disabled="disabled" checked name="blSelect" lay-filter="hqSelect"  value="1" title="总部" type="checkbox">
                      <#else>
                        <input  lay-skin="primary" id="hqBl" disabled="disabled" name="blSelect" lay-filter="hqSelect"  value="1" title="总部" type="checkbox">
                    </#if>
                </div>
                </td>
                <td class="my_td_selectLeft">
                  <label class="layui-form-label" style="margin: 0px;width: auto;">工作地</label>
                  <div class="layui-input-inline">
                    <input id="hqInputId" value="${hqInput!}" class="layui-input" style="margin: 8px;width: auto;"
                           disabled="disabled"/>
                  </div>
                </td>
              </tr>
              <tr>
                <td  class="my_td_select">
                  <div class="layui-form-item" pane="">
                    <#assign myflag=0>
                      <#list blList as bl>
                        <#if (bl==2)>
                          <#assign myflag=1>
                            <#break/>
                        </#if>
                      </#list>
                      <#if myflag=1>
                        <input  lay-skin="primary" disabled="disabled" name="blSelect" checked id="clBl" lay-filter="clSelect" value="2" title="信贷" type="checkbox">
                        <#else>
                          <input  lay-skin="primary" disabled="disabled" name="blSelect" id="clBl" lay-filter="clSelect" value="2" title="信贷" type="checkbox">
                      </#if>
                  </div>
                </td>
                <td class="my_td_selectLeft">
                  <label class="layui-form-label" style="margin: 6px;width: auto;">部门</label>
                  <div class="layui-input-inline">
                    <input id="clInputId" value="${xdInput!}" class="layui-input" style="margin: 10px;width: auto;"
                           disabled="disabled"/>
                  </div>
                </td>
                </td>
              </tr>
              <tr>
                <td  class="my_td_select">
                  <div class="layui-form-item" pane="">
                    <#assign myflag=0>
                      <#list blList as bl>
                        <#if (bl==3)>
                          <#assign myflag=1>
                            <#break/>
                        </#if>
                      </#list>
                      <#if myflag=1>
                        <input  lay-skin="primary" title="消分"  disabled="disabled" checked name="blSelect" lay-filter="cfSelect" id="cfBl" value="3" type="checkbox">
                        <#else>
                          <input  lay-skin="primary" title="消分" disabled="disabled" name="blSelect" lay-filter="cfSelect" id="cfBl" value="3" type="checkbox">
                      </#if>
                  </div>
                </td>
                <td class="my_td_selectLeft">
                  <label class="layui-form-label" style="margin: 6px;width: auto;">部门</label>
                  <div class="layui-input-inline">
                    <input id="cfInputId" value="${xfInput!}" class="layui-input" style="margin: 10px;width: auto;"
                           disabled="disabled"/>
                  </div>
                </td>
              </tr>
              </tbody>
            </table>
          </div>
        </td>
      </tr>
      <tr>
    <td class="my_lebel">
      <label class="control-label">角色</label>
    </td>
    <td class="my_content" colspan="4">
      <div style="border: 1px solid rgba(0, 0, 0, .3); border-radius: 3px; height: 150px; overflow-y: auto; padding: 5px;">
        <#if allSysRoles?? && (allSysRoles?size > 0) >
          <table style="width: 100%;">
            <tr>
              <#assign flag=0>
                <!---->
                <#list allSysRoles as allRole>
                  <!---->
                  <#assign flag=flag+1>
                    <td class="my_cb">
                      <#assign flag2=0>
                        <!---->
                        <#list userSysRoles as userRole>
                          <!---->
                          <#if userRole.roleId! == allRole.roleId>
                            <!---->
                            <#assign flag2=1>
                              <!---->
                              <#break>
                                <!---->
                          </#if>
                          <!---->
                        </#list>
                        <!---->
                        <#if flag2==1>
                          <input type="checkbox" name="roleIds" lay-skin="primary" value="${allRole.roleId!}" checked="checked" disabled="disabled">
                          <#else>
                            <input type="checkbox" name="roleIds" lay-skin="primary" value="${allRole.roleId!}" disabled="disabled">
                        </#if>
                    </td>
                    <td class="my_cb_title">
                      <font>${allRole.roleName!}</font>
                    </td>
                    <#if flag==3>
            </tr>
            <tr>
              <#assign flag=0>
                <!---->
        </#if>
        <!---->
        </#list>
        </tr>
        </table>
      </div>
    </form>
    <script type="text/javascript" src="${ctx}/ui/js/plugins/layui/layui.js"></script>
    <script type="text/javascript" src="${ctx}/ui/js/jquery.min.js"></script>
    <script type="text/javascript" src="${ctx}/ui/jquery-easyui-1.3.3/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="${ctx}/ui/js/vendor/modernizr.js"></script>
    <script type="text/javascript" src="${ctx}/ui/js/vendor.js"></script>
    <script type="text/javascript" src="${ctx}/ui/js/plugins/grid/grid.zh-CN.min.js"></script>
    <script type="text/javascript" src="${ctx}/ui/js/plugins/grid/bsgrid.all.min.js"></script>
    <script type="text/javascript" src="${ctx}/ui/js/plugins/validform/Validform_v5.3.2_min.js"></script>
    <script type="text/javascript" src="${ctx}/ui/js/plugins/layer/layer.js"></script>
    <script type="text/javascript" src="${ctx}/ui/js/bootstrap/bootstrap.min.js"></script>
    <script type="text/javascript" src="${ctx}/ui/js/plugins/iCheck/icheck.min.js"></script>
    <script type="text/javascript" src="${ctx}/ui/js/common.js"></script>
    <script type="text/javascript">
        var form;
        layui.use('form',function () {
            form = layui.form;
        });
    </script>
  </#if>
  <#elseif type == "edit">
  <form id="form" class="layui-form">
    <input name="id" id="id" value="${user.id!}" style="display: none;">
    <div class="ibox-content" style="min-height: 650px; max-height: 650px; padding: 10px; overflow: auto;">
    <table style="border-collapse: separate; border-spacing: 0px 5px;">
      <tr>
        <td class="my_lebel">
          <label class="control-label">
            <font color="red">*</font>
            真实姓名
          </label>
        </td>
        <td class="my_content">
          <input id="fullName" readonly name="fullName" type="text" class="form-control input-sm" value="${user.fullName!}" />
        </td>
        <td class="my_lebel">
          <label class="control-label">电话号码</label>
        </td>
        <td class="my_content">
          <input id="teleNum" name="teleNum" type="text" class="form-control input-sm" value="${user.teleNum!}" />
        </td>
      </tr>
      <tr>
        <td class="my_lebel">
          <label class="control-label">
            <font color="red">*</font>
            登录名
          </label>
        </td>
        <td class="my_content">
          <input id="userName" name="userName" readonly type="text" class="form-control input-sm" value="${user.userName!}" />
        </td>
        <td class="my_lebel">
          <label class="control-label">新密码</label>
        </td>
        <td class="my_content">
          <input name=pwd type="password" class="form-control input-sm" placeholder="缺省不修改" />
        </td>
      </tr>
      <tr>
        <td class="my_lebel">
          <label class="control-label">
            <font color="red">*</font>
            手机
          </label>
        </td>
        <td class="my_content">
          <input id="mobile" name="mobile" type="text" class="form-control input-sm" value="${user.mobile!}" />
        </td>
        <td class="my_lebel">
          <label class="control-label">
            <font color="red">*</font>
            E-mail
          </label>
        </td>
        <td class="my_content">
          <input id="email" name="email" type="text" class="form-control input-sm" value="${user.email!}" />
        </td>
      </tr>
      <tr>
        <td class="my_lebel">
          <label class="control-label">
            <font color="red">*</font>
            员工编号
          </label>
        </td>
        <td class="my_content">
          <input id="empNo" name="empNo" readonly type="text" class="form-control input-sm" value="${user.empNo!}" />
        </td>
        <td class="my_lebel">
          <label class="control-label">
            <font color="red">*</font>
            是否有效
          </label>
        </td>
        <td class="my_content">
          <select id="isEnable" name="isEnable" class="form-control input-sm">
            <#if user.isEnable == 1>
            <option value="1" selected="selected">有效</option>
            <option value="0">无效</option>
            <#elseif user.isEnable == 0>
            <option value="1">有效</option>
            <option value="0" selected="selected">无效</option>
            </#if>
          </select>
        </td>
      </tr>
      <tr>
        <td class="my_lebel">
          <label class="control-label">权限范围</label>
        </td>
        <td class="my_content" colspan="4">
          <div style="border: 1px solid rgba(0, 0, 0, .3); border-radius: 3px; height: 300px;">
            <table class="table table-bordered ">
              <tbody>
              <tr>
                <td class="my_td_select">
                  <div class="layui-form-item" pane="">
                    <#assign myflag=0>
                    <#list blList as bl>
                      <#if (bl==0)>
                        <#assign myflag=1>
                          <#break/>
                      </#if>
                    </#list>
                      <#if myflag=1>
                        <input  lay-skin="primary" id="allBl" name="blSelect" checked lay-filter="allBlSelect" value="0" title="全部" type="checkbox" >
                        <#else>
                          <input  lay-skin="primary" id="allBl" name="blSelect" lay-filter="allBlSelect" value="0" title="全部" type="checkbox" >
                      </#if>
                  </div>
                </td>
                <td class="my_td_selectLeft">
                  <label class="layui-form-label" style="margin: 6px;width: auto;">部门</label>
                  <div class="layui-input-inline">
                    <input id="allInputId" value="${allInput!}"  class="layui-input" style="margin: 10px;width: auto;" readonly
                           onclick="showTree(0,'allTree','allTreeContent','allInputId',1)"/>
                  </div>
                  <div id="allTreeContent"
                       style="width: 360px;height: 224px; border-radius:5px;display: none; z-index:9999;position: absolute; border: 1px #CCC solid; background-color:#f9f9f9;">
                    <ul id="allTree" class="ztree" style="margin-top:0;height: 200px;overflow: auto;"></ul>
                  </div>
                </td>
              </tr>
              <tr>
                <td  class="my_td_select"/>
                <div class="layui-form-item" pane="">
                  <#assign myflag=0>
                    <#list blList as bl>
                      <#if (bl==1)>
                        <#assign myflag=1>
                          <#break/>
                      </#if>
                    </#list>
                    <#if myflag=1>
                      <input  lay-skin="primary" id="hqBl" checked name="blSelect" lay-filter="hqSelect"  value="1" title="总部" type="checkbox">
                      <#else>
                        <input  lay-skin="primary" id="hqBl" name="blSelect" lay-filter="hqSelect"  value="1" title="总部" type="checkbox">
                    </#if>
                </div>
                </td>
                <td class="my_td_selectLeft">
                  <label class="layui-form-label" style="margin: 0px;width: auto;">工作地</label>
                  <div class="layui-input-inline">
                    <input id="hqInputId" value="${hqInput!}" class="layui-input" style="margin: 8px;width: auto;"
                           readonly
                           onclick="showTree(1,'hqTree','hqTreeContent','hqInputId',1)"/>
                  </div>
                  <div id="hqTreeContent"
                       style="width: 360px;height: 224px; border-radius:5px;display: none; z-index:9999;position: absolute; border: 1px #CCC solid; background-color:#f9f9f9;">
                    <ul id="hqTree" class="ztree" style="margin-top:0;height: 200px;overflow: auto;"></ul>
                  </div>
                </td>
              </tr>
              <tr>
                <td  class="my_td_select">
                  <div class="layui-form-item" pane="">
                    <#assign myflag=0>
                      <#list blList as bl>
                        <#if (bl==2)>
                          <#assign myflag=1>
                            <#break/>
                        </#if>
                      </#list>
                      <#if myflag=1>
                        <input  lay-skin="primary" name="blSelect" checked id="clBl" lay-filter="clSelect" value="2" title="信贷" type="checkbox">
                        <#else>
                          <input  lay-skin="primary" name="blSelect" id="clBl" lay-filter="clSelect" value="2" title="信贷" type="checkbox">
                      </#if>
                  </div>
                </td>
                <td class="my_td_selectLeft">
                  <label class="layui-form-label" style="margin: 6px;width: auto;">部门</label>
                  <div class="layui-input-inline">
                    <input id="clInputId" value="${xdInput!}" class="layui-input" style="margin: 10px;width: auto;"
                           readonly
                           onclick="showTree(2,'clTree','clTreeContent','clInputId',1)"/>
                  </div>
                  <div id="clTreeContent" style="width: 360px;height: 224px; border-radius:5px;display: none; z-index:9999;position: absolute; border: 1px #CCC solid; background-color:#f9f9f9;">
                    <ul id="clTree" class="ztree" style="margin-top:0;height: 200px;overflow: auto;"></ul>
                  </div>
                </td>
                </td>
              </tr>
              <tr>
                <td  class="my_td_select">
                  <div class="layui-form-item" pane="">
                    <#assign myflag=0>
                      <#list blList as bl>
                        <#if (bl==3)>
                          <#assign myflag=1>
                            <#break/>
                        </#if>
                      </#list>
                      <#if myflag=1>
                        <input  lay-skin="primary" title="消分"  checked name="blSelect" lay-filter="cfSelect" id="cfBl" value="3" type="checkbox">
                        <#else>
                          <input  lay-skin="primary" title="消分" name="blSelect" lay-filter="cfSelect" id="cfBl" value="3" type="checkbox">
                      </#if>
                  </div>
                </td>
                <td class="my_td_selectLeft">
                  <label class="layui-form-label" style="margin: 6px;width: auto;">部门</label>
                  <div class="layui-input-inline">
                    <input id="cfInputId" value="${xfInput!}" class="layui-input" style="margin: 10px;width: auto;"
                           readonly
                           onclick="showTree(3,'cfTree','cfTreeContent','cfInputId',1)"/>
                  </div>
                  <div id="cfTreeContent"
                       style="width: 360px;height: 224px; border-radius:5px;display: none; z-index:9999;position: absolute; border: 1px #CCC solid; background-color:#f9f9f9;">
                    <ul id="cfTree" class="ztree" style="margin-top:0;height: 200px;overflow: auto;"></ul>
                  </div>
                </td>
              </tr>
              </tbody>
            </table>
          </div>
        </td>
      </tr>
      <tr>
        <td class="my_lebel">
          <label class="control-label">角色</label>
        </td>
        <td class="my_content" colspan="4">
          <div style="border: 1px solid rgba(0, 0, 0, .3); border-radius: 3px; height: 150px; overflow-y: auto; padding: 5px;">
            <#if allSysRoles?? && (allSysRoles?size > 0) >
              <table style="width: 100%;">
                <tr>
                  <#assign flag=0>
                    <!---->
                    <#list allSysRoles as allRole>
                      <!---->
                      <#assign flag=flag+1>
                        <td class="my_cb">
                          <#assign flag2=0>
                            <!---->
                            <#list userSysRoles as userRole>
                              <!---->
                              <#if userRole.roleId! == allRole.roleId>
                                <!---->
                                <#assign flag2=1>
                                  <!---->
                                  <#break>
                                    <!---->
                              </#if>
                              <!---->
                            </#list>
                            <!---->
                            <#if flag2==1>
                              <input type="checkbox" name="roleIds" lay-skin="primary"  value="${allRole.roleId!}" checked="checked">
                              <#else>
                                <input type="checkbox" name="roleIds" lay-skin="primary"  value="${allRole.roleId!}">
                            </#if>
                        </td>
                        <td class="my_cb_title">
                          <font>${allRole.roleName!}</font>
                        </td>
                        <#if flag==3>
                </tr>
                <tr>
                  <#assign flag=0>
                    <!---->
            </#if>
            <!---->
            </#list>
      </tr>
   </table>
  </div>
  </form>
    </#if>
    <link rel="stylesheet" type="text/css" href="/ui/easyui-1.5.1/themes/insdep/easyui.css">
    <link rel="stylesheet" href="${ctx}/ui/css/plugins/zTree_v3/metroStyle/metroStyle.css" type="text/css">
    <script type="text/javascript" src="${ctx}/ui/js/plugins/zTree_v3//jquery-1.4.4.min.js"></script>
    <script type="text/javascript" src="${ctx}/ui/js/plugins/zTree_v3/jquery.ztree.core-3.5.js"></script>
    <script type="text/javascript" src="${ctx}/ui/js/plugins/zTree_v3/jquery.ztree.excheck-3.5.js"></script>
    <script type="text/javascript" src="${ctx}/ui/js/plugins/zTree_v3/jquery.ztree.exedit-3.5.js"></script>
    <script type="text/javascript" src="${ctx}/ui/js/plugins/layui/layui.js"></script>
    <script type="text/javascript" src="/ui/easyui-1.5.1/jquery.easyui-1.5.1.min.js"></script>
    <script type="text/javascript" src="/ui/easyui-1.5.1/jquery.easyui-1.5.1.min.js"></script>
  <script type="text/javascript">
      var form;
      var allZtreeObj;
      var hqZtreeObj;
      var clZtreeObj;
      var cfZtreeObj;
      var treeData;
      var userId;
      var hqSelectVal;
      var allSelectVal;
      var clSelectVal;
      var cfSelectVal;
      var checkedArray;
      var isSetUserIdFlag=true;

      layui.use('form',function () {
          form = layui.form;
          form.on('checkbox(allBlSelect)',function (data) {
              var checked = data.elem.checked;
              if(checked){
                  $("#hqBl").attr({disabled:true,checked:false});
                  $("#clBl").attr({disabled:true,checked:false});
                  $("#cfBl").attr({disabled:true,checked:false});
                  $("#hqInputId").attr({disabled:true,value:''});
                  $("#clInputId").attr({disabled:true,value:''});
                  $("#cfInputId").attr({disabled:true,value:''});
                  $("#hqInputId").css('backgroundColor','#f9f9f9');
                  $("#clInputId").css('backgroundColor','#f9f9f9');
                  $("#cfInputId").css('backgroundColor','#f9f9f9');
                  hqZtreeObj=null;
                  clZtreeObj=null;
                  cfZtreeObj=null;
                  allSelectVal=true;

                /*取消勾选的时候清空右侧input值和tree值*/
                  $("#allInputId").val("");
                  allZtreeObj=null;
                  form.render('checkbox');
              }else{
                  $('#hqBl').removeAttr("disabled");
                  $('#clBl').removeAttr("disabled");
                  $('#cfBl').removeAttr("disabled");
                  $('#hqInputId').removeAttr("disabled");
                  $('#clInputId').removeAttr("disabled");
                  $('#cfInputId').removeAttr("disabled");
                  $("#hqInputId").css('backgroundColor','');
                  $("#clInputId").css('backgroundColor','');
                  $("#cfInputId").css('backgroundColor','');

                  allSelectVal=false;

                /*取消勾选的时候清空右侧input值和tree值*/
                  $("#allInputId").val("");
                  allZtreeObj=null;
                  isSetUserIdFlag=false;
                  form.render('checkbox');
              }
          });
          form.on('checkbox(hqSelect)',function (data) {
              var checked = data.elem.checked;
              if(checked){
                  hqSelectVal=true;
              }else{
                  hqSelectVal=false;
                /*取消勾选的时候清空右侧input值和tree值*/
                  $("#hqInputId").val("");
                  hqZtreeObj=null;
                  isSetUserIdFlag=false;
                  form.render();
              }
            /*总部勾选的时候，如果信贷和消分勾了就不能取消全部不能勾选的状态*/
              if(!clSelectVal&&!cfSelectVal){
                  clickChangeAllBl(checked)
              }
          });
          form.on('checkbox(clSelect)',function (data) {
              var checked = data.elem.checked;
              if(checked){
                  clSelectVal=true;
              }else{
                  clSelectVal=false;
                /*取消勾选的时候清空右侧input值和tree值*/
                  $("#clInputId").val("");
                  clZtreeObj=null;
                  isSetUserIdFlag=false;
                  form.render();
              }
            /*信贷勾选的时候，如果总部和消分勾了就不能取消全部不能勾选的状态*/
              if(!hqSelectVal&&!cfSelectVal){
                  clickChangeAllBl(checked)
              }
          });
          form.on('checkbox(cfSelect)',function (data) {
              var checked = data.elem.checked;
              if(checked){
                  cfSelectVal=true;
              }else{
                  cfSelectVal=false;
                /*取消勾选的时候清空右侧input值和tree值*/
                  $("#cfInputId").val("");
                  cfZtreeObj=null;
                  isSetUserIdFlag=false;
                  form.render();
              }
              if(!hqSelectVal&&!clSelectVal){
                  clickChangeAllBl(checked)
              }
          });
      });


      function clickChangeAllBl(checked) {
          if(checked){
              $("#allBl").attr({disabled:true,checked:false});
              $("#allInputId").attr({disabled:true,value:''});
              $("#allInputId").css('backgroundColor','#f9f9f9');
              allZtreeObj=null;
              form.render('checkbox');
          }else{
              $('#allBl').removeAttr("disabled");
              $('#allInputId').removeAttr("disabled");
              $("#allInputId").css('backgroundColor','');
              form.render('checkbox');
          }
      }

      var setting = {
          async : {
              dataFilter: function (id, pNode, res) {
                  if (res.code == 200) {
                      if (res && res.data)
                          return res.data;
                  } else {
                      layer.alert("加载树失败："+res.msg, {
                          icon : 5,
                          title : "失败"
                      });
                      return [];
                  }
              },
              enable: true,
              url:"${ctx}/hqclcf/hqclcfdept/tree",
              autoParam:["id"],
              otherParam:{"data":function(){return treeData},"userId":function(){return userId}}
          },
          view: {
              dblClickExpand: false,
              showLine:false
          },
          check: {
              enable: true,
              chkStyle: "checkbox",
              chkboxType: { "Y": "s", "N": "s" }
          },
          data: {
              simpleData: {
                  enable: true,
                  idKey:"id",
                  pIdKey:"pid"
              }
          },
          callback: {
              onAsyncSuccess:function (event, treeId, treeNode, msg) {
                  if(allZtreeObj!=null){
                      allZtreeObj.expandAll(false);
                  }
                  if(hqZtreeObj!=null){
                      hqZtreeObj.expandAll(false);
                  }
                  if(clZtreeObj!=null){
                      clZtreeObj.expandAll(false);
                  }
                  if(cfZtreeObj!=null){
                      cfZtreeObj.expandAll(false);
                  }
              },
              onCheck: function (e, treeId, treeNode) {
                  if(allZtreeObj!=null&&allSelectVal){
                      attrValueToInput(allZtreeObj,'allInputId');
                  }
                  if(hqZtreeObj!=null&&hqSelectVal){
                      attrValueToInput(hqZtreeObj,'hqInputId');
                  }
                  if(clZtreeObj!=null&&clSelectVal){
                      attrValueToInput(clZtreeObj,'clInputId');
                  }
                  if(cfZtreeObj!=null&&cfSelectVal){
                      attrValueToInput(cfZtreeObj,'cfInputId');
                  }
              }
          }
      };

      function attrValueToInput(treeObj, inputId) {
          var nodes = treeObj.getCheckedNodes(true);
          var v = "";
          for (var i = 0, l = nodes.length; i < l; i++) {
              v += nodes[i].name + ",";
          }
          if (v.length > 0) v = v.substring(0, v.length - 1);
          var inputId = $("#" + inputId + "");
          inputId.attr("value", v);
      }

      function getTreeData(intv,treeId) {
          var obj=new Object();
          obj.isSuperior="NO";
          obj.status=1;
          var data;
          switch (intv){
              case 0:
                  obj.businessLine="";
                  data=JSON.stringify(obj);
                  break;
              case 1:
                  obj.businessLine=intv;
                  data=JSON.stringify(obj);
                  break;
              case 2:
                  obj.businessLine=3;
                  data=JSON.stringify(obj);
                  break;
              case 3:
                  obj.businessLine=2;
                  data=JSON.stringify(obj);
                  break;
          }

          var id = $("#id").val();
          treeData=data;
          switch (intv){
              case 0:
                  var allfalg = getFlagIsSetUserId(0);
                  if(!allfalg&&isSetUserIdFlag){
                      userId=id;
                  }else{
                      userId="";
                  }
                  allZtreeObj = $.fn.zTree.init($("#"+treeId+""), setting);
                  break;
              case 1:
                  var hqfalg = getFlagIsSetUserId(1);
                  if(!hqfalg&&isSetUserIdFlag){
                      userId=id;
                  }else{
                      userId="";
                  }
                  hqZtreeObj = $.fn.zTree.init($("#"+treeId+""), setting);
                  break;
              case 2:
                  var clfalg = getFlagIsSetUserId(2);
                  if(!clfalg&&isSetUserIdFlag){
                      userId=id;
                  }else{
                      userId="";
                  }
                  clZtreeObj = $.fn.zTree.init($("#"+treeId+""), setting);
                  break;
              case 3:
                  var cffalg = getFlagIsSetUserId(3);
                  if(!cffalg&&isSetUserIdFlag){
                      userId=id;
                  }else{
                      userId="";
                  }
                  cfZtreeObj = $.fn.zTree.init($("#"+treeId+""), setting);
                  break;
          }
      }
    
      function getFlagIsSetUserId(intval) {
          var falg=true;
          for(i = 0; i < checkedArray.length; i++) {
             if(intval==checkedArray[i]){
                 falg=false;
                 break;
             }
          }
          return falg;
      }
      
      $(document).ready(function(){
           checkedArray =[];
          <#if blList??>
          <#list blList as item>
            checkedArray.push("${item}");
          </#list>
          </#if>
          for(j = 0; j < checkedArray.length; j++) {
              var bl = checkedArray[j];

              if(bl==0){
                  readyAllbackgrodchange();
                  allSelectVal=true;
              }else if(bl==1){
                  readyOtherbackgrodchange();
                  hqSelectVal=true;
              }else if(bl==2){
                  readyOtherbackgrodchange();
                  clSelectVal=true;
              }else if(bl==3){
                  readyOtherbackgrodchange();
                  cfSelectVal=true;
              }
          }
          showTree(0,'allTree','allTreeContent','allInputId',2);
          showTree(1,'hqTree','hqTreeContent','hqInputId',2);
          showTree(2,'clTree','clTreeContent','clInputId',2);
          showTree(3,'cfTree','cfTreeContent','cfInputId',2);
      });

    function readyAllbackgrodchange() {
        $("#hqBl").attr({disabled:true,checked:false});
        $("#clBl").attr({disabled:true,checked:false});
        $("#cfBl").attr({disabled:true,checked:false});
        $("#hqInputId").attr({disabled:true,value:''});
        $("#clInputId").attr({disabled:true,value:''});
        $("#cfInputId").attr({disabled:true,value:''});
        $("#hqInputId").css('backgroundColor','#f9f9f9');
        $("#clInputId").css('backgroundColor','#f9f9f9');
        $("#cfInputId").css('backgroundColor','#f9f9f9');
    }

    function readyOtherbackgrodchange() {
        $("#allBl").attr({disabled:true,checked:false});
        $("#allInputId").attr({disabled:true,value:''});
        $("#allInputId").css('backgroundColor','#f9f9f9');
    }

      function showTree(intv,treeId,contentId,inputId,type) {
          switch (intv){
              case 0:
                  if(allZtreeObj==null){
                      getTreeData(intv,treeId);
                  }
                  break;
              case 1:
                  if(hqZtreeObj==null){
                      getTreeData(intv,treeId);
                  }
                  break;
              case 2:
                  if(clZtreeObj==null){
                      getTreeData(intv,treeId);
                  }
                  break;
              case 3:
                  if(cfZtreeObj==null){
                      getTreeData(intv,treeId);
                  }
                  break;
          }
          if(type==1){
              var deptOffset = $("#"+inputId+"").offset();
              $("#"+contentId+"").css({
                  left: deptOffset.left  + "px",
                  top: deptOffset.top +28+ "px"
              }).slideDown("fast");

              $("body").bind("mousedown",function onBodyDown(event) {
                  var length = $(event.target).parents("#"+treeId+"").length;
                  var id = event.target.id;
                  if(!(length==1||(length==0&&id==''+treeId+''))){
                      $("#"+contentId+"").fadeOut("fast");
                      $("body").unbind("mousedown", onBodyDown);
                  }
              });
          }
      }


      function checkSelect() {
          var flag = true;
          var hqInputId = $("#hqInputId").val();
          var allInputId = $("#allInputId").val();
          var cfInputId = $("#cfInputId").val();
          var clInputId = $("#clInputId").val();
          if (allSelectVal && allInputId == '') {
              validateTips('您勾选了全部选项', '，请选择对应的部门再提交');
              flag = false;
              return flag;
          }
          if (hqSelectVal && hqInputId == '') {
              validateTips('您勾选了总部选项', '，请选择对应的工作地再提交');
              flag = false;
              return flag;
          }
          if (clSelectVal && clInputId == '') {
              validateTips('您勾选了信贷选项', '，请选择对应的部门再提交');
              flag = false;
              return flag;
          }
          if (cfSelectVal && cfInputId == '') {
              validateTips('您勾选了消分选项', '，请选择对应的部门再提交');
              flag = false;
              return flag;
          }
          return flag;
      };

      function save() {
          var data = getFormData();
				if (checkInput()&&checkSelect()) {
                    var data = getFormData();
					$.ajax({
						url : '${ctx}/sys/user/saveEdit',
						type : 'post',
						dataType : 'json',
						data : {"data":JSON.stringify(data)},
						cache : false,
						beforeSend : function(xhr) {
						},
						success : function(res) {
							if (res.code == 200) {
                                layer.msg("修改成功", {icon: 6});
                                setTimeout(
                                    function() {
                                        parent.doSearch();
                                        closeWin();
                                        var url ="${ctx}/sys/user/index.mvc";
                                        window.location.href=url;
                                    }, 1000);
							} else {
								var msg = res.msg ?res.msg : "保存失败！";
								layer.msg(msg, {
									time : 1000
								});
							}
						},
						error : function(xhr, errorType, errorInfo) {
							var res = xhr.responseJSON;
							var msg = res.msg ? "[" + res.code + "]" + res.msg : "请求错误！";
							layer.msg(msg, {
								time : 2000
							});
						},
						complete : function(xhr, ts) {
						}
					});
				}
			}
      function buildArry(treeObj,arry) {
          var nodes = treeObj.getCheckedNodes(true);
          for (var i = 0, l = nodes.length; i < l; i++) {
              var id = nodes[i].id;
              arry.push(id);
          }
          return arry;
      }


      $('#fullName').combogrid({
          loadMsg: 'Loading···',
          panelWidth: 450,
          delay: 500,
          mode: 'remote',
          url: '${ctx}/hqclcf/hqclcfPersonTransfer/queryByq',
          idField: 'empNo',
          textField: 'empName',
          method: 'post',
          columns: [[
              {field: 'empNo', title: '员工编码', width: 100, sortable: true},
              {field: 'empName', title: '员工姓名', width: 100, sortable: true},
              {field: 'mobilePhone', title: '手机号码', width: 120, sortable: true},
              {field: 'email', title: '邮箱', width:120 , sortable: true}
          ]],
          onSelect: function (index, row) {
              $("#empNo").val(row['empNo']);
              $("#userName").val(row['empNo']);
              $("#mobile").val(row['mobilePhone']);
              $("#email").val(row['email']);
          }
      });

      function getFormData() {
          var dataObj=new Object();
          var formData = $.fn.serializeObject($("#form"));
          var data=new Object();
          var blArray=[];
          var roleArray=[];
          if(typeof(formData.blSelect)=='undefined'){
              data.blSelect=blArray;
          }else{
              if(Array.isArray(formData.blSelect)){
                  for(var i = 0, l =  formData.blSelect.length; i < l; i++){
                      blArray.push(formData.blSelect[i]);
                  }
                  data.blSelect=blArray;
              }else{
                  blArray.push(formData.blSelect);
                  data.blSelect=blArray;
              }
          }
          if(typeof(formData.roleIds)=='undefined'){
              data.roleIds=roleArray;
          }else{
              if(Array.isArray(formData.roleIds)){
                  for(var i = 0, l =  formData.roleIds.length; i < l; i++){
                      roleArray.push(formData.roleIds[i]);
                  }
                  data.roleIds=roleArray;
              }else{
                  roleArray.push(formData.roleIds);
                  data.roleIds=roleArray;
              }
          }
          data.id=$("#id").val();
          if(typeof(formData.email)=='undefined'){
              data.email="";
          }else{
              data.email=formData.email;
          }
          if(typeof(formData.empNo)=='undefined'){
              data.empNo="";
          }else{
              data.empNo=formData.empNo;
          }
          if(typeof(formData.fullName)=='undefined'){
              data.fullName="";
          }else{
              data.fullName=formData.fullName;
          }
          if(typeof(formData.isEnable)=='undefined'){
              data.isEnable="";
          }else{
              data.isEnable=formData.isEnable;
          }
          if(typeof(formData.mobile)=='undefined'){
              data.mobile="";
          }else{
              data.mobile=formData.mobile;
          }
          if(typeof(formData.pwd)=='undefined'){
              data.pwd="";
          }else{
              data.pwd=formData.pwd;
          }
          if(typeof(formData.teleNum)=='undefined'){
              data.teleNum="";
          }else{
              data.teleNum=formData.teleNum;
          }
          if(typeof(formData.userName)=='undefined'){
              data.userName="";
          }else{
              data.userName=formData.userName;
          }
          dataObj.data=data;
          var allArray=new Array();
          if (allZtreeObj != null) {
              allArray = buildArry(allZtreeObj,allArray);
          }
          dataObj.allNodes=allArray;
          var hqArray=new Array();
          if (hqZtreeObj != null) {
              hqArray = buildArry(hqZtreeObj,hqArray);
          }
          dataObj.hqNodes=hqArray;
          var clArray=new Array();
          if (clZtreeObj != null) {
              clArray = buildArry(clZtreeObj,clArray);
          }
          dataObj.clNodes=clArray;
          var cfArray=new Array();
          if (cfZtreeObj != null) {
              cfArray = buildArry(cfZtreeObj,cfArray);
          }
          dataObj.cfNodes=cfArray;
          return dataObj;
      }

      function validateTips(filedName,msg){
          layer.msg("<font style='color: paleturquoise'>"+filedName+"</font>"+msg+"",{
              anim:6,
          });
      }
		</script>
  <#elseif type == "add">
  <form id="form" autocomplete="off" class="layui-form">
    <div class="ibox-content" style="min-height: 650px; max-height: 650px; padding: 10px; overflow: auto;">
    <table style="border-collapse: separate; border-spacing: 0px 5px;">
      <tr>
        <td class="my_lebel">
          <label class="control-label">
            <font color="red">*</font>
            真实姓名
          </label>
        </td>
        <td class="my_content">
          <input id="fullName" name="fullName" type="text" class="form-control input-sm" />
        </td>
        <td class="my_lebel">
          <label class="control-label">电话号码</label>
        </td>
        <td class="my_content">
          <input id="teleNum" name="teleNum"  type="text" class="form-control input-sm" />
        </td>
      </tr>
      <tr>
        <td class="my_lebel">
          <label class="control-label">
            <font color="red">*</font>
            登录名
          </label>
        </td>
        <td class="my_content">
          <input id="userName" name="userName" type="text" class="form-control input-sm" />
        </td>
        <td class="my_lebel">
          <label class="control-label">初始密码</label>
        </td>
        <td class="my_content">
          <input name=pwd type="password" class="form-control input-sm" placeholder="缺省时为12345678" />
        </td>
      </tr>
      <tr>
        <td class="my_lebel">
          <label class="control-label">
            <font color="red">*</font>
            手机
          </label>
        </td>
        <td class="my_content">
          <input id="mobile" name="mobile" type="text" class="form-control input-sm" />
        </td>
        <td class="my_lebel">
          <label class="control-label">
            <font color="red">*</font>
            E-mail
          </label>
        </td>
        <td class="my_content">
          <input id="email" name="email" type="text" class="form-control input-sm" />
        </td>
      </tr>
      <tr>
        <td class="my_lebel">
          <label class="control-label">
            <font color="red">*</font>
            员工编号
          </label>
        </td>
        <td class="my_content">
          <input id="empNo" name="empNo" type="text" class="form-control input-sm" />
        </td>
        <td class="my_lebel">
          <label class="control-label">
            <font color="red">*</font>
            是否有效
          </label>
        </td>
        <td class="my_content">
          <select id="isEnable" name="isEnable" class="form-control input-sm">
            <option value="1" selected="selected">有效</option>
            <option value="0">无效</option>
          </select>
        </td>
      </tr>
      <tr>
        <td class="my_lebel">
          <label class="control-label">权限范围</label>
        </td>
        <td class="my_content" colspan="4">
          <div style="border: 1px solid rgba(0, 0, 0, .3); border-radius: 3px; height: 300px;">
            <table class="table table-bordered ">
              <tbody>
              <tr>
                  <td class="my_td_select">
                    <div class="layui-form-item" pane="">
                        <input  lay-skin="primary" id="allBl" name="blSelect" lay-filter="allBlSelect" value="0" title="全部" type="checkbox" >
                    </div>
                  </td>
                      <td class="my_td_selectLeft">
                        <label class="layui-form-label" style="margin: 6px;width: auto;">部门</label>
                        <div class="layui-input-inline">
                          <input id="allInputId" value=""  class="layui-input" style="margin: 10px;width: auto;" readonly
                                 onclick="showTree(0,'allTree','allTreeContent','allInputId')"/>
                        </div>
                        <div id="allTreeContent"
                             style="width: 360px;height: 224px; border-radius:5px;display: none; z-index:9999;position: absolute; border: 1px #CCC solid; background-color:#f9f9f9;">
                          <ul id="allTree" class="ztree" style="margin-top:0;height: 200px;overflow: auto;"></ul>
                        </div>
                      </td>
                      </tr>
                      <tr>
                      <td  class="my_td_select"/>
                      <div class="layui-form-item" pane="">
                      <input  lay-skin="primary" id="hqBl" name="blSelect" lay-filter="hqSelect"  value="1" title="总部" type="checkbox">
                      </div>
                      </td>
                        <td class="my_td_selectLeft">
                          <label class="layui-form-label" style="margin: 0px;width: auto;">工作地</label>
                          <div class="layui-input-inline">
                            <input id="hqInputId" value="" class="layui-input" style="margin: 8px;width: auto;"
                                   readonly
                                   onclick="showTree(1,'hqTree','hqTreeContent','hqInputId')"/>
                          </div>
                          <div id="hqTreeContent"
                               style="width: 360px;height: 224px; border-radius:5px;display: none; z-index:9999;position: absolute; border: 1px #CCC solid; background-color:#f9f9f9;">
                            <ul id="hqTree" class="ztree" style="margin-top:0;height: 200px;overflow: auto;"></ul>
                          </div>
                        </td>
                      </tr>
                      <tr>
                      <td  class="my_td_select">
                      <div class="layui-form-item" pane="">
                      <input  lay-skin="primary" name="blSelect" id="clBl" lay-filter="clSelect" value="2" title="信贷" type="checkbox">
                      </div>
                      </td>
                      <td class="my_td_selectLeft">
                        <label class="layui-form-label" style="margin: 6px;width: auto;">部门</label>
                        <div class="layui-input-inline">
                          <input id="clInputId" value="" class="layui-input" style="margin: 10px;width: auto;"
                                 readonly
                                 onclick="showTree(2,'clTree','clTreeContent','clInputId')"/>
                        </div>
                        <div id="clTreeContent"
                             style="width: 360px;height: 224px; border-radius:5px;display: none; z-index:9999;position: absolute; border: 1px #CCC solid; background-color:#f9f9f9;">
                          <ul id="clTree" class="ztree" style="margin-top:0;height: 200px;overflow: auto;"></ul>
                        </div>
                        </td>
                      </td>
                      </tr>
                      <tr>
                      <td  class="my_td_select">
                      <div class="layui-form-item" pane="">
                      <input  lay-skin="primary" title="消分" name="blSelect" lay-filter="cfSelect" id="cfBl" value="3" type="checkbox">
                      </div>
                      </td>
                      <td class="my_td_selectLeft">
                        <label class="layui-form-label" style="margin: 6px;width: auto;">部门</label>
                        <div class="layui-input-inline">
                          <input id="cfInputId" value="" class="layui-input" style="margin: 10px;width: auto;"
                                 readonly
                                 onclick="showTree(3,'cfTree','cfTreeContent','cfInputId')"/>
                        </div>
                        <div id="cfTreeContent"
                             style="width: 360px;height: 224px; border-radius:5px;display: none; z-index:9999;position: absolute; border: 1px #CCC solid; background-color:#f9f9f9;">
                          <ul id="cfTree" class="ztree" style="margin-top:0;height: 200px;overflow: auto;"></ul>
                        </div>
                      </td>
                      </tr>
                      </tbody>
                      </table>
                      </div>
                      </td>
                      </tr>
                      <tr>
                      <td class="my_lebel">
                      <label class="control-label">角色</label>
                      </td>
                      <td class="my_content" colspan="4">
                      <div style="border: 1px solid rgba(0, 0, 0, .3); border-radius: 3px; height: 150px; overflow-y: auto; padding: 5px;">
                      <#if allSysRoles?? && (allSysRoles?size > 0) >
                  <table style="width: 100%;">
                      <tr>
                    <tr>
                    </tr>
                      <#assign flag=0>
                      <!---->
                      <#list allSysRoles as allRole>
                  <!---->
                  <#assign flag=flag+1>
                      <td class="my_cb">
                      <div class="layui-form-item" pane="">
                      <input type="checkbox" name="roleIds"  lay-skin="primary"  value="${allRole.roleId!}">
                      </div>
                      <!-- <input type="checkbox" name="roleIds" value="${allRole.roleId!}">-->
                      </td>
                      <td class="my_cb_title">
                      <font>${allRole.roleName!}</font>
                      </td>
                      <#if flag==3>
                  </tr>
                  <tr>
                  <#assign flag=0>
                      <!---->
                      </#if>
                  <!---->
                  </#list>
                  </tr>
                  </table>
                  </#if>
                  </div>
                  </td>
                  </tr>
                  </table>
                  </div>
                  </form>
    <link rel="stylesheet" href="${ctx}/ui/css/plugins/zTree_v3/metroStyle/metroStyle.css" type="text/css">
    <link rel="stylesheet" type="text/css" href="/ui/easyui-1.5.1/themes/insdep/easyui.css">
    <script type="text/javascript" src="${ctx}/ui/js/plugins/zTree_v3//jquery-1.4.4.min.js"></script>
    <script type="text/javascript" src="${ctx}/ui/js/plugins/zTree_v3/jquery.ztree.core-3.5.js"></script>
    <script type="text/javascript" src="${ctx}/ui/js/plugins/zTree_v3/jquery.ztree.excheck-3.5.js"></script>
    <script type="text/javascript" src="${ctx}/ui/js/plugins/zTree_v3/jquery.ztree.exedit-3.5.js"></script>
    <script type="text/javascript" src="${ctx}/ui/js/plugins/layui/layui.js"></script>
    <script type="text/javascript" src="/ui/easyui-1.5.1/jquery.easyui-1.5.1.min.js"></script>
    <script type="text/javascript" src="/ui/easyui-1.5.1/jquery.easyui-1.5.1.min.js"></script>
    <script type="text/javascript">
        var form;
        var allZtreeObj;
        var hqZtreeObj;
        var clZtreeObj;
        var cfZtreeObj;
        var treeData;
        var hqSelectVal;
        var allSelectVal;
        var clSelectVal;
        var cfSelectVal;

        layui.use('form',function () {
            form = layui.form;
            form.on('checkbox(allBlSelect)',function (data) {
                var checked = data.elem.checked;
                if(checked){
                    $("#hqBl").attr({disabled:true,checked:false});
                    $("#clBl").attr({disabled:true,checked:false});
                    $("#cfBl").attr({disabled:true,checked:false});
                    $("#hqInputId").attr({disabled:true,value:''});
                    $("#clInputId").attr({disabled:true,value:''});
                    $("#cfInputId").attr({disabled:true,value:''});
                    $("#hqInputId").css('backgroundColor','#f9f9f9');
                    $("#clInputId").css('backgroundColor','#f9f9f9');
                    $("#cfInputId").css('backgroundColor','#f9f9f9');
                    hqZtreeObj=null;
                    clZtreeObj=null;
                    cfZtreeObj=null;
                    allSelectVal=true;
                    form.render('checkbox');
                }else{
                    $('#hqBl').removeAttr("disabled");
                    $('#clBl').removeAttr("disabled");
                    $('#cfBl').removeAttr("disabled");
                    $('#hqInputId').removeAttr("disabled");
                    $('#clInputId').removeAttr("disabled");
                    $('#cfInputId').removeAttr("disabled");
                    $("#hqInputId").css('backgroundColor','');
                    $("#clInputId").css('backgroundColor','');
                    $("#cfInputId").css('backgroundColor','');
                    allSelectVal=false;

                  /*取消勾选的时候清空右侧input值和tree值*/
                    $("#allInputId").val("");
                    allZtreeObj=null;
                    form.render('checkbox');
                }
            });
            form.on('checkbox(hqSelect)',function (data) {
                var checked = data.elem.checked;
                if(checked){
                    hqSelectVal=true;
                }else{
                    hqSelectVal=false;
                    /*取消勾选的时候清空右侧input值和tree值*/
                    $("#hqInputId").val("");
                    hqZtreeObj=null;
                    form.render();
                }
                /*总部勾选的时候，如果信贷和消分勾了就不能取消全部不能勾选的状态*/
                if(!clSelectVal&&!cfSelectVal){
                    clickChangeAllBl(checked)
                }
            });
            form.on('checkbox(clSelect)',function (data) {
                var checked = data.elem.checked;
                if(checked){
                    clSelectVal=true;
                }else{
                    clSelectVal=false;
                    /*取消勾选的时候清空右侧input值和tree值*/
                    $("#clInputId").val("");
                    clZtreeObj=null;
                    form.render();
                }
              /*信贷勾选的时候，如果总部和消分勾了就不能取消全部不能勾选的状态*/
                if(!hqSelectVal&&!cfSelectVal){
                    clickChangeAllBl(checked)
                }
            });
            form.on('checkbox(cfSelect)',function (data) {
                var checked = data.elem.checked;
                if(checked){
                    cfSelectVal=true;
                }else{
                    cfSelectVal=false;
                  /*取消勾选的时候清空右侧input值和tree值*/
                    $("#cfInputId").val("");
                    cfZtreeObj=null;
                    form.render();
                }
                if(!hqSelectVal&&!clSelectVal){
                    clickChangeAllBl(checked)
                }
            });
        });


      function clickChangeAllBl(checked) {
          if(checked){
              $("#allBl").attr({disabled:true,checked:false});
              $("#allInputId").attr({disabled:true,value:''});
              $("#allInputId").css('backgroundColor','#f9f9f9');
              allZtreeObj=null;
              form.render('checkbox');
          }else{
              $('#allBl').removeAttr("disabled");
              $('#allInputId').removeAttr("disabled");
              $("#allInputId").css('backgroundColor','');
              form.render('checkbox');
          }
      }


        var setting = {
            async : {
                dataFilter: function (id, pNode, res) {
                    if (res.code == 200) {
                        if (res && res.data)
                            return res.data;
                    } else {
                        layer.alert("加载树失败："+res.msg, {
                            icon : 5,
                            title : "失败"
                        });
                        return [];
                    }
                },
                enable: true,
                url:"${ctx}/hqclcf/hqclcfdept/tree",
                autoParam:["id"],
                otherParam:{"data":function(){return treeData}}
            },
            view: {
                dblClickExpand: false,
                showLine:false
            },
            check: {
                enable: true,
                chkStyle: "checkbox",
                chkboxType: { "Y": "s", "N": "s" }
            },
            data: {
                simpleData: {
                    enable: true,
                    idKey:"id",
                    pIdKey:"pid"
                }
            },
            callback: {
                onAsyncSuccess:function (event, treeId, treeNode, msg) {
                    if(allZtreeObj!=null){
                        allZtreeObj.expandAll(false);
                    }
                    if(hqZtreeObj!=null){
                        hqZtreeObj.expandAll(false);
                    }
                    if(clZtreeObj!=null){
                        clZtreeObj.expandAll(false);
                    }
                    if(cfZtreeObj!=null){
                        cfZtreeObj.expandAll(false);
                    }
                },
                onCheck: function (e, treeId, treeNode) {
                    if(allZtreeObj!=null){
                        attrValueToInput(allZtreeObj,'allInputId');
                    }
                    if(hqZtreeObj!=null){
                        attrValueToInput(hqZtreeObj,'hqInputId');
                    }
                    if(clZtreeObj!=null){
                        attrValueToInput(clZtreeObj,'clInputId');
                    }
                    if(cfZtreeObj!=null){
                        attrValueToInput(cfZtreeObj,'cfInputId');
                    }
                }
            }
        };

        function attrValueToInput(treeObj, inputId) {
            var nodes = treeObj.getCheckedNodes(true);
            var v = "";
            for (var i = 0, l = nodes.length; i < l; i++) {
                v += nodes[i].name + ",";
            }
            if (v.length > 0) v = v.substring(0, v.length - 1);
            var inputId = $("#" + inputId + "");
            inputId.attr("value", v);
        }

        function getTreeData(intv,treeId) {
            var obj=new Object();
            obj.isSuperior="NO";
            obj.status=1;
            var data;
             switch (intv){
                 case 0:
                     obj.businessLine="";
                     data=JSON.stringify(obj);
                     break;
                 case 1:
                     obj.businessLine=intv;
                     data=JSON.stringify(obj);
                     break;
                 case 2:
                     obj.businessLine=3;
                     data=JSON.stringify(obj);
                     break;
                 case 3:
                     obj.businessLine=2;
                     data=JSON.stringify(obj);
                     break;
             }

            treeData=data;
            switch (intv){
                case 0:
                    allZtreeObj = $.fn.zTree.init($("#"+treeId+""), setting);
                    break;
                case 1:
                    hqZtreeObj = $.fn.zTree.init($("#"+treeId+""), setting);
                    break;
                case 2:
                    clZtreeObj = $.fn.zTree.init($("#"+treeId+""), setting);
                    break;
                case 3:
                    cfZtreeObj = $.fn.zTree.init($("#"+treeId+""), setting);
                    break;
            }
        }

        function showTree(intv,treeId,contentId,inputId) {
            switch (intv){
                case 0:
                    if(allZtreeObj==null){
                        getTreeData(intv,treeId);
                    }
                    break;
                case 1:
                    if(hqZtreeObj==null){
                        getTreeData(intv,treeId);
                    }
                    break;
                case 2:
                    if(clZtreeObj==null){
                        getTreeData(intv,treeId);
                    }
                    break;
                case 3:
                    if(cfZtreeObj==null){
                        getTreeData(intv,treeId);
                    }
                    break;
            }
            var deptOffset = $("#"+inputId+"").offset();
            $("#"+contentId+"").css({
                left: deptOffset.left  + "px",
                top: deptOffset.top +28+ "px"
            }).slideDown("fast");

            $("body").bind("mousedown",function onBodyDown(event) {
                var length = $(event.target).parents("#"+treeId+"").length;
                var id = event.target.id;
                if(!(length==1||(length==0&&id==''+treeId+''))){
                    $("#"+contentId+"").fadeOut("fast");
                    $("body").unbind("mousedown", onBodyDown);
                }
            });
      }

        function checkSelect() {
            var flag = true;
            var hqInputId = $("#hqInputId").val();
            var allInputId = $("#allInputId").val();
            var cfInputId = $("#cfInputId").val();
            var clInputId = $("#clInputId").val();
            if (allSelectVal && allInputId == '') {
                validateAddDeptTips('您勾选了全部选项', '，请选择对应的部门再提交');
                flag = false;
                return flag;
            }
            if (hqSelectVal && hqInputId == '') {
                validateAddDeptTips('您勾选了总部选项', '，请选择对应的工作地再提交');
                flag = false;
                return flag;
            }
            if (clSelectVal && clInputId == '') {
                validateAddDeptTips('您勾选了信贷选项', '，请选择对应的部门再提交');
                flag = false;
                return flag;
            }
            if (cfSelectVal && cfInputId == '') {
                validateAddDeptTips('您勾选了消分选项', '，请选择对应的部门再提交');
                flag = false;
                return flag;
            }
            return flag;
        };

        function save() {
            var data = getFormData();
            if (checkInput()&&checkSelect()) {
                $.ajax({
                    url: '${ctx}/sys/user/saveAdd',
                    type: 'post',
                    dataType: 'json',
                    data: {"data": JSON.stringify(data)},
                    cache: false,
                    beforeSend: function (xhr) {
                    },
                    success: function (res) {
                        if (res.code == 200) {
                            layer.msg("保存成功", {icon: 6});
                            setTimeout(
                                function() {
                                    parent.doSearch();
                                    closeWin();
                                    var url ="${ctx}/sys/user/index.mvc";
                                    window.location.href=url;
                                }, 1000);
                        } else {
                            var msg = res.msg ? res.msg : "保存失败！";
                            layer.msg(msg, {
                                time: 1000
                            });
                        }
                    },
                    error: function (xhr, errorType, errorInfo) {
                        var res = xhr.responseJSON;
                        var msg = res.msg ? "[" + res.code + "]" + res.msg : "请求错误！";
                        layer.msg(msg, {
                            time: 2000
                        });
                    },
                    complete: function (xhr, ts) {
                    }
                });
            }
        }


        function validateAddDeptTips(filedName,msg){
            layer.msg("<font style='color: paleturquoise'>"+filedName+"</font>"+msg+"",{
                anim:6,
            });
        }

        function buildArry(treeObj,arry) {
            var nodes = treeObj.getCheckedNodes(true);
            for (var i = 0, l = nodes.length; i < l; i++) {
                var id = nodes[i].id;
                arry.push(id);
            }
            return arry;
        }


        $('#fullName').combogrid({
            loadMsg: '加载中，请稍等···',
            panelWidth: 480,
            panelHeight:400,
            delay: 500,
            mode: 'remote',
            url: '${ctx}/sys/user/queryEmpByBl',
            idField: 'empName',
            textField: 'empName',
            method: 'post',
            striped : true,
            rownumbers : true,
            pagination : true,
            pageSize : 10,
            pageList : [10,50,100],
            columns: [[
                {field: 'empNo', title: '员工编码', width: 100, sortable: true},
                {field: 'empName', title: '员工姓名', width: 100, sortable: true},
                {field: 'mobilePhone', title: '手机号码', width: 120, sortable: true},
                {field: 'email', title: '邮箱', width:120 , sortable: true}
            ]],
            onSelect: function (index, row) {
                $("#empNo").val(row['empNo']);
                $("#userName").val(row['empNo']);
                $("#mobile").val(row['mobilePhone']);
                $("#email").val(row['email']);
            }
        });


        function getFormData() {
            var dataObj=new Object();
            var formData = $.fn.serializeObject($("#form"));
            var data=new Object();
            var blArray=[];
            var roleArray=[];
            if(typeof(formData.blSelect)=='undefined'){
                data.blSelect=blArray;
            }else{
                if(Array.isArray(formData.blSelect)){
                    for(var i = 0, l =  formData.blSelect.length; i < l; i++){
                        blArray.push(formData.blSelect[i]);
                    }
                    data.blSelect=blArray;
                }else{
                    blArray.push(formData.blSelect);
                    data.blSelect=blArray;
                }
            }
            if(typeof(formData.roleIds)=='undefined'){
                data.roleIds=roleArray;
            }else{
                if(Array.isArray(formData.roleIds)){
                    for(var i = 0, l =  formData.roleIds.length; i < l; i++){
                        roleArray.push(formData.roleIds[i]);
                    }
                    data.roleIds=roleArray;
                }else{
                    roleArray.push(formData.roleIds);
                    data.roleIds=roleArray;
                }
            }
            if(typeof(formData.email)=='undefined'){
                data.email="";
            }else{
                data.email=formData.email;
            }
            if(typeof(formData.empNo)=='undefined'){
                data.empNo="";
            }else{
                data.empNo=formData.empNo;
            }
            if(typeof(formData.fullName)=='undefined'){
                data.fullName="";
            }else{
                data.fullName=formData.fullName;
            }
            if(typeof(formData.isEnable)=='undefined'){
                data.isEnable="";
            }else{
                data.isEnable=formData.isEnable;
            }
            if(typeof(formData.mobile)=='undefined'){
                data.mobile="";
            }else{
                data.mobile=formData.mobile;
            }
            if(typeof(formData.pwd)=='undefined'){
                data.pwd="";
            }else{
                data.pwd=formData.pwd;
            }
            if(typeof(formData.teleNum)=='undefined'){
                data.teleNum="";
            }else{
                data.teleNum=formData.teleNum;
            }
            if(typeof(formData.userName)=='undefined'){
                data.userName="";
            }else{
                data.userName=formData.userName;
            }
            dataObj.data=data;
            var allArray=new Array();
            if (allZtreeObj != null) {
                allArray = buildArry(allZtreeObj,allArray);
            }
            dataObj.allNodes=allArray;
            var hqArray=new Array();
            if (hqZtreeObj != null) {
                hqArray = buildArry(hqZtreeObj,hqArray);
            }
            dataObj.hqNodes=hqArray;
            var clArray=new Array();
            if (clZtreeObj != null) {
                clArray = buildArry(clZtreeObj,clArray);
            }
            dataObj.clNodes=clArray;
            var cfArray=new Array();
            if (cfZtreeObj != null) {
                cfArray = buildArry(cfZtreeObj,cfArray);
            }
            dataObj.cfNodes=cfArray;
            return dataObj;
        }
		</script>
  </#if>
</body>
<script type="text/javascript" src="${ctx}/ui/js/plugins/grid/grid.zh-CN.min.js"></script>
<script type="text/javascript" src="${ctx}/ui/js/plugins/grid/bsgrid.all.min.js"></script>
<script type="text/javascript" src="${ctx}/ui/js/plugins/layer/layer.js"></script>
<script type="text/javascript" src="${ctx}/ui/js/plugins/iCheck/icheck.min.js"></script>
<script type="text/javascript" src="${ctx}/ui/js/common.js"></script>
<script type="text/javascript">
	$(function() {
		$(".my_cb_title").click(function() {
			$(this).prev().find("input").click();
		});
	});

	function checkInput() {
		var layerAlert = function(msg, obj) {
			index = layer.msg(msg, {
				time : 0,
				btn : [ '确定' ],
				yes : function() {
					obj.focus();
					layer.close(index);
				}
			});
		};
		var $userName = $("#userName");
		if (!$userName.val()) {
			layerAlert("登录名不能为空！", $userName);
			return false;
		}
		var $fullName = $("#fullName");
		if (!$fullName.val()) {
			layerAlert("真实姓名不能为空！", $fullName);
			return false;
		}
		var $mobile = $("#mobile");
		if (!$mobile.val()) {
			layerAlert("手机不能为空！", $mobile);
			return false;
		}
		var $email = $("#email");
		if (!$email.val()) {
			layerAlert("E-mail不能为空！", $email);
			return false;
		}
		var $empNo = $("#empNo");
		if (!$empNo.val()) {
			layerAlert("员工编号不能为空！", $empNo);
			return false;
		}
		var $isEnable = $("#isEnable");
		if (!$isEnable.val()) {
			layerAlert("状态不能为空！", $isEnable);
			return false;
		}
		return true;
	}

	function reset() {
		$("#form")[0].reset();
	}

	function closeWin() {
		var index = parent.layer.getFrameIndex(window.name);
		parent.layer.close(index);
	}
</script>
</html>
</@compress>
